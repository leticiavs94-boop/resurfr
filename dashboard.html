<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resurfr â€” Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800;900&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--yellow:#C8E62B;--ydim:rgba(200,230,43,0.12);--green:#1E4D35;--glight:#4CAF80;--off:#F4F6F1;--border:#E2E8DC;--charcoal:#181C17;--text:#1A1F18;--muted:#6B7A65;--lmuted:#9DAA96;--sw:240px;}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{height:100%}
body{font-family:'DM Sans',sans-serif;background:var(--off);color:var(--text);min-height:100vh}
#loading-screen{position:fixed;inset:0;background:var(--charcoal);display:flex;align-items:center;justify-content:center;z-index:999;flex-direction:column;gap:16px}
#loading-screen .logo{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:900;color:white}
#loading-screen .spin{width:24px;height:24px;border:3px solid rgba(255,255,255,0.2);border-top-color:var(--yellow);border-radius:50%;animation:spin .7s linear infinite}
#app{display:none}
@keyframes spin{to{transform:rotate(360deg)}}
.layout{display:flex;min-height:100vh}
.sidebar{width:var(--sw);background:var(--charcoal);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;transition:transform .3s}
.sidebar-logo{padding:20px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,0.07);margin-bottom:8px}
.logo-badge{background:var(--yellow);border-radius:8px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.logo-text{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;color:white}
.nav-label{font-size:9px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:rgba(255,255,255,0.2);padding:10px 20px 4px}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 20px;margin:1px 8px;border-radius:8px;font-size:13px;font-weight:500;color:rgba(255,255,255,0.45);cursor:pointer;transition:all .2s;border:1px solid transparent;user-select:none;text-decoration:none}
.nav-item svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0}
.nav-item:hover{background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.8)}
.nav-item.active{background:var(--ydim);color:var(--yellow);border-color:rgba(200,230,43,0.2)}
.nav-item.active svg{stroke:var(--yellow)}
.nav-badge{margin-left:auto;background:var(--yellow);color:var(--charcoal);font-size:9px;font-weight:800;border-radius:10px;padding:1px 6px;line-height:1.4}
.sidebar-footer{margin-top:auto;padding:16px;border-top:1px solid rgba(255,255,255,0.07)}
.user-card{display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(255,255,255,0.05);border-radius:10px}
.user-av{width:32px;height:32px;border-radius:8px;background:var(--green);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;color:white;flex-shrink:0}
.user-name{font-size:12px;font-weight:600;color:rgba(255,255,255,0.8);line-height:1.2;word-break:break-all}
.sign-out{font-size:10px;color:rgba(255,255,255,0.3);cursor:pointer;margin-top:2px;transition:color .2s}
.sign-out:hover{color:rgba(255,255,255,0.6)}
.main{margin-left:var(--sw);flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{background:white;border-bottom:1px solid var(--border);padding:0 24px;height:56px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;flex-shrink:0}
.topbar-left{display:flex;align-items:center;gap:12px}
.menu-btn{display:none;background:none;border:none;cursor:pointer;padding:4px;color:var(--charcoal)}
.menu-btn svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round}
.page-title{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--charcoal)}
.topbar-right{display:flex;align-items:center;gap:8px}
.btn{padding:8px 16px;border-radius:7px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .2s;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
.btn svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2.5;stroke-linecap:round}
.btn-yellow{background:var(--yellow);color:var(--charcoal)}.btn-yellow:hover{background:#d4f030}
.btn-ghost{background:var(--off);color:var(--muted);border:1px solid var(--border)}
.content{padding:20px 24px;flex:1}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.stat{background:white;border:1px solid var(--border);border-radius:12px;padding:18px 20px;position:relative;overflow:hidden}
.stat::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.stat.s1::before{background:var(--yellow)}.stat.s2::before{background:var(--glight)}.stat.s3::before{background:#F0B429}.stat.s4::before{background:var(--green)}
.stat-lbl{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--lmuted);margin-bottom:6px}
.stat-val{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:900;color:var(--charcoal);line-height:1;margin-bottom:4px}
.stat-sub{font-size:11px;color:var(--lmuted)}
.panel{background:white;border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:16px}
.panel-head{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
.panel-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;color:var(--charcoal)}
.panel-link{font-size:11px;font-weight:600;color:var(--green);cursor:pointer;background:none;border:none;font-family:'DM Sans',sans-serif}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.tbl{width:100%;border-collapse:collapse}
.tbl th{padding:9px 16px;text-align:left;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--lmuted);background:var(--off);border-bottom:1px solid var(--border)}
.tbl td{padding:11px 16px;border-bottom:1px solid var(--border);font-size:13px;color:var(--text);vertical-align:middle}
.tbl tr:last-child td{border-bottom:none}
.tbl tbody tr:hover td{background:#FAFFF8}
.tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
.c-row{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);gap:10px}
.c-row:last-child{border-bottom:none}
.c-av{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:800;flex-shrink:0;background:#E8F2EC;color:var(--green)}
.c-name{font-size:13px;font-weight:600;color:var(--charcoal)}
.c-meta{font-size:11px;color:var(--lmuted);margin-top:1px}
.tag{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;letter-spacing:0.5px;white-space:nowrap}
.tag-hard{background:#FDF3E0;color:#B8842A}.tag-hartru{background:#E8F5EE;color:#2A7A52}.tag-clay{background:#FDEEE8;color:#A84E2A}.tag-def{background:var(--off);color:var(--muted)}
.badge{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;white-space:nowrap}
.b-paid{background:#E8F5EE;color:#2A7A52}.b-pending{background:#FFF8E6;color:#B88000}.b-overdue{background:#FDEEE8;color:#A84E2A}.b-scheduled{background:#EEF0FF;color:#3040C0}.b-completed{background:#E8F5EE;color:#2A7A52}.b-cancelled{background:var(--off);color:var(--muted);border:1px solid var(--border)}
.empty{padding:40px 20px;text-align:center;color:var(--lmuted)}
.empty p{font-size:13px;margin-top:8px}
.view{display:none}.view.active{display:block}

/* Row action buttons */
.row-actions{display:flex;align-items:center;gap:6px;opacity:0;transition:opacity .15s}
.tbl tbody tr:hover .row-actions{opacity:1}
.act-btn{padding:4px 10px;border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;border:none;font-family:'DM Sans',sans-serif;transition:all .15s;white-space:nowrap}
.act-edit{background:var(--off);color:var(--muted);border:1px solid var(--border)}
.act-edit:hover{border-color:var(--charcoal);color:var(--charcoal)}
.act-delete{background:#FDF0EE;color:#A84E2A;border:1px solid #F5D4CF}
.act-delete:hover{background:#FDEEE8}
.act-paid{background:#E8F5EE;color:#2A7A52;border:1px solid #C8E8D8}
.act-paid:hover{background:#D4EEE0}
/* Always show on mobile */
@media(max-width:768px){.row-actions{opacity:1}}

/* Modal */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:200;display:none;align-items:flex-end;justify-content:center}
.overlay.open{display:flex}
.modal{background:white;border-radius:20px 20px 0 0;padding:24px 20px 32px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto}
.modal-title{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--charcoal);margin-bottom:4px}
.modal-sub{font-size:12px;color:var(--lmuted);margin-bottom:16px}
.fg{margin-bottom:12px}
.fl{display:block;font-size:10px;font-weight:700;letter-spacing:0.5px;color:var(--lmuted);margin-bottom:4px;text-transform:uppercase}
.fi{width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:15px;color:var(--charcoal);outline:none;transition:border-color .2s;background:var(--off);-webkit-appearance:none}
.fi:focus{border-color:var(--green);background:white}
.fi::placeholder{color:#C8D0C2}
.modal-btns{display:flex;gap:10px;margin-top:18px}
.modal-btns button{flex:1;padding:13px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.b-cancel{background:var(--off);color:var(--muted);border:1px solid var(--border)}
.b-save{background:var(--charcoal);color:white}.b-save:hover{background:var(--green)}.b-save:disabled{opacity:0.6;cursor:not-allowed}
.b-danger{background:#FDEEE8;color:#A84E2A;border:1px solid #F5D4CF}.b-danger:hover{background:#F9E0DA}

/* Confirm dialog */
.confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:300;display:none;align-items:center;justify-content:center;padding:20px}
.confirm-overlay.open{display:flex}
.confirm-box{background:white;border-radius:16px;padding:28px 24px;max-width:360px;width:100%;text-align:center}
.confirm-title{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--charcoal);margin-bottom:8px}
.confirm-msg{font-size:14px;color:var(--muted);margin-bottom:24px;line-height:1.5}
.confirm-btns{display:flex;gap:10px}
.confirm-btns button{flex:1;padding:12px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;border:none;transition:all .2s}

.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--charcoal);color:white;padding:12px 24px;border-radius:10px;font-size:13px;font-weight:500;z-index:400;opacity:0;transition:all .3s;white-space:nowrap}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}.toast.ok{background:var(--green)}
.spinner{width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin .6s linear infinite;flex-shrink:0}
.loading{display:flex;align-items:center;justify-content:center;gap:8px;padding:32px;color:var(--lmuted);font-size:13px}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99}
@media(max-width:768px){
  .sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}
  .sidebar-overlay.open{display:block}.main{margin-left:0}.menu-btn{display:flex}
  .stats{grid-template-columns:1fr 1fr}.grid2{grid-template-columns:1fr}
  .content{padding:16px}.topbar{padding:0 16px}.tbl th,.tbl td{padding:9px 12px}
  .topbar-date{display:none}
}
@media(max-width:400px){.stats{grid-template-columns:1fr}.stat-val{font-size:28px}}
</style>
</head>
<body>

<div id="loading-screen"><div class="logo">Resurfr</div><div class="spin"></div></div>
<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

<div id="app">
<div class="layout">

<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-badge">
      <svg width="20" height="20" viewBox="0 0 40 40" fill="none">
        <rect x="2" y="5" width="36" height="30" rx="3.5" fill="rgba(26,31,24,0.08)" stroke="#1A1F18" stroke-width="2.2"/>
        <line x1="2" y1="20" x2="38" y2="20" stroke="#1A1F18" stroke-width="2.5"/>
        <line x1="20" y1="5" x2="20" y2="35" stroke="#1A1F18" stroke-width="1.5"/>
        <line x1="10" y1="5" x2="10" y2="20" stroke="#1A1F18" stroke-width="1.2"/>
        <line x1="30" y1="5" x2="30" y2="20" stroke="#1A1F18" stroke-width="1.2"/>
        <path d="M2 27 Q11 22 20 27 Q29 32 38 27" stroke="#1A1F18" stroke-width="2.5" stroke-linecap="round" fill="none"/>
      </svg>
    </div>
    <span class="logo-text">Resurfr</span>
  </div>
  <div class="nav-label">Main</div>
  <div class="nav-item active" onclick="nav('dashboard',this)">
    <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
    Dashboard
  </div>
  <div class="nav-item" onclick="nav('clients',this)">
    <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    Clients <span class="nav-badge" id="nb-clients">0</span>
  </div>
  <div class="nav-item" onclick="nav('jobs',this)">
    <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    Jobs
  </div>
  <div class="nav-label" style="margin-top:8px">Finance</div>
  <div class="nav-item" onclick="nav('invoices',this)">
    <svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
    Invoices <span class="nav-badge" id="nb-invoices">0</span>
  </div>
  <div class="nav-label" style="margin-top:8px">Tools</div>
  <a class="nav-item" href="/map.html">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="10" r="3"/><path d="M12 2a8 8 0 0 0-8 8c0 5.4 7.05 11.5 7.65 12 .19.16.51.16.7 0C12.95 21.5 20 15.4 20 10a8 8 0 0 0-8-8z"/></svg>
    Court Map
  </a>
  <div class="sidebar-footer">
    <div class="user-card">
      <div class="user-av" id="user-av">?</div>
      <div style="min-width:0">
        <div class="user-name" id="user-email">Loading...</div>
        <div class="sign-out" onclick="signOut()">Sign out</div>
      </div>
    </div>
  </div>
</aside>

<div class="main">

  <!-- DASHBOARD -->
  <div id="view-dashboard" class="view active">
    <div class="topbar">
      <div class="topbar-left">
        <button class="menu-btn" onclick="openSidebar()"><svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
        <div class="page-title">Dashboard</div>
      </div>
      <div class="topbar-right">
        <span id="today-date" style="font-size:12px;color:var(--lmuted)"></span>
        <button class="btn btn-yellow" onclick="openModal('client')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add Client</button>
      </div>
    </div>
    <div class="content">
      <div class="stats">
        <div class="stat s1"><div class="stat-lbl">Total Billed</div><div class="stat-val" id="s-revenue">$0</div><div class="stat-sub">All time</div></div>
        <div class="stat s2"><div class="stat-lbl">Clients</div><div class="stat-val" id="s-clients">0</div><div class="stat-sub">Active</div></div>
        <div class="stat s3"><div class="stat-lbl">Pending</div><div class="stat-val" id="s-pending">$0</div><div class="stat-sub" id="s-pending-sub">0 invoices</div></div>
        <div class="stat s4"><div class="stat-lbl">Jobs</div><div class="stat-val" id="s-jobs">0</div><div class="stat-sub">Total</div></div>
      </div>
      <div class="grid2">
        <div class="panel"><div class="panel-head"><div class="panel-title">Recent Clients</div><button class="panel-link" onclick="nav('clients',null)">View all</button></div><div id="d-clients"><div class="loading"><div class="spinner"></div>Loading...</div></div></div>
        <div class="panel"><div class="panel-head"><div class="panel-title">Recent Jobs</div><button class="panel-link" onclick="nav('jobs',null)">View all</button></div><div id="d-jobs"><div class="loading"><div class="spinner"></div>Loading...</div></div></div>
      </div>
      <div class="panel"><div class="panel-head"><div class="panel-title">Recent Invoices</div><button class="panel-link" onclick="nav('invoices',null)">View all</button></div><div id="d-invoices"><div class="loading"><div class="spinner"></div>Loading...</div></div></div>
    </div>
  </div>

  <!-- CLIENTS -->
  <div id="view-clients" class="view">
    <div class="topbar">
      <div class="topbar-left"><button class="menu-btn" onclick="openSidebar()"><svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="page-title">Clients</div></div>
      <button class="btn btn-yellow" onclick="openModal('client')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add Client</button>
    </div>
    <div class="content"><div class="panel"><div class="tbl-wrap"><div id="clients-list"><div class="loading"><div class="spinner"></div>Loading...</div></div></div></div></div>
  </div>

  <!-- JOBS -->
  <div id="view-jobs" class="view">
    <div class="topbar">
      <div class="topbar-left"><button class="menu-btn" onclick="openSidebar()"><svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="page-title">Jobs</div></div>
      <button class="btn btn-yellow" onclick="openModal('job')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add Job</button>
    </div>
    <div class="content"><div class="panel"><div class="tbl-wrap"><div id="jobs-list"><div class="loading"><div class="spinner"></div>Loading...</div></div></div></div></div>
  </div>

  <!-- INVOICES -->
  <div id="view-invoices" class="view">
    <div class="topbar">
      <div class="topbar-left"><button class="menu-btn" onclick="openSidebar()"><svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="page-title">Invoices</div></div>
      <button class="btn btn-yellow" onclick="openModal('invoice')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>New Invoice</button>
    </div>
    <div class="content"><div class="panel"><div class="tbl-wrap"><div id="invoices-list"><div class="loading"><div class="spinner"></div>Loading...</div></div></div></div></div>
  </div>

</div>
</div>
</div>

<!-- CLIENT MODAL -->
<div class="overlay" id="m-client">
  <div class="modal">
    <div class="modal-title" id="client-modal-title">Add Client</div>
    <div class="modal-sub" id="client-modal-sub"></div>
    <div class="fg"><label class="fl">Facility Name</label><input type="text" class="fi" id="c-name" placeholder="Westport Tennis Club"></div>
    <div class="fg"><label class="fl">Location</label><input type="text" class="fi" id="c-loc" placeholder="Westport, CT"></div>
    <div class="fg"><label class="fl">Surface Type</label>
      <select class="fi" id="c-surface"><option value="">Select surface</option><option value="Har-Tru">Har-Tru</option><option value="Hard">Hard Court</option><option value="Red Clay">Red Clay</option></select>
    </div>
    <div class="fg"><label class="fl">Number of Courts</label><input type="number" class="fi" id="c-courts" placeholder="4" min="1"></div>
    <div class="fg"><label class="fl">Notes</label><input type="text" class="fi" id="c-notes" placeholder="Optional notes..."></div>
    <div class="modal-btns">
      <button class="b-cancel" onclick="closeModal('client')">Cancel</button>
      <button class="b-save" id="save-client-btn" onclick="saveClient()">Save Client</button>
    </div>
  </div>
</div>

<!-- JOB MODAL -->
<div class="overlay" id="m-job">
  <div class="modal">
    <div class="modal-title" id="job-modal-title">Add Job</div>
    <div class="modal-sub" id="job-modal-sub"></div>
    <div class="fg"><label class="fl">Client</label><select class="fi" id="j-client"></select></div>
    <div class="fg"><label class="fl">Service</label><input type="text" class="fi" id="j-service" placeholder="Har-Tru topdressing"></div>
    <div class="fg"><label class="fl">Date</label><input type="date" class="fi" id="j-date"></div>
    <div class="fg"><label class="fl">Amount ($)</label><input type="number" class="fi" id="j-amount" placeholder="3800"></div>
    <div class="fg"><label class="fl">Status</label>
      <select class="fi" id="j-status"><option value="scheduled">Scheduled</option><option value="completed">Completed</option><option value="cancelled">Cancelled</option></select>
    </div>
    <div class="modal-btns">
      <button class="b-cancel" onclick="closeModal('job')">Cancel</button>
      <button class="b-save" id="save-job-btn" onclick="saveJob()">Save Job</button>
    </div>
  </div>
</div>

<!-- INVOICE MODAL -->
<div class="overlay" id="m-invoice">
  <div class="modal">
    <div class="modal-title" id="invoice-modal-title">New Invoice</div>
    <div class="modal-sub" id="invoice-modal-sub"></div>
    <div class="fg"><label class="fl">Client</label><select class="fi" id="i-client"></select></div>
    <div class="fg"><label class="fl">Amount ($)</label><input type="number" class="fi" id="i-amount" placeholder="3800"></div>
    <div class="fg"><label class="fl">Status</label>
      <select class="fi" id="i-status"><option value="pending">Pending</option><option value="paid">Paid</option><option value="overdue">Overdue</option></select>
    </div>
    <div class="modal-btns">
      <button class="b-cancel" onclick="closeModal('invoice')">Cancel</button>
      <button class="b-save" id="save-invoice-btn" onclick="saveInvoice()">Save Invoice</button>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-box">
    <div class="confirm-title">Delete this?</div>
    <div class="confirm-msg" id="confirm-msg">This cannot be undone.</div>
    <div class="confirm-btns">
      <button class="b-cancel" onclick="closeConfirm()">Cancel</button>
      <button class="b-danger" id="confirm-ok-btn">Delete</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const{createClient}=supabase;
const sb=createClient('https://qyrgkspwxjmbjnkaixag.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5cmdrc3B3eGptYmpua2FpeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NzQ0NTgsImV4cCI6MjA4NzU1MDQ1OH0.AHE_1iR8De17u-bVwsfzPc0nKK8MCDB5SEU5Ks531DA');

let clients=[],jobs=[],invoices=[];
let editingId={client:null,job:null,invoice:null};

// â”€â”€ BOOT â”€â”€
async function boot(){
  const{data:{session}}=await sb.auth.getSession();
  if(!session){window.location.href='/login.html';return;}
  const email=session.user.email;
  document.getElementById('user-email').textContent=email;
  document.getElementById('user-av').textContent=email.substring(0,2).toUpperCase();
  document.getElementById('today-date').textContent=new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric',year:'numeric'});
  await Promise.all([loadClients(),loadJobs(),loadInvoices()]);
  renderDashboard();
  document.getElementById('loading-screen').style.display='none';
  document.getElementById('app').style.display='block';
}
boot();

async function signOut(){await sb.auth.signOut();window.location.href='/login.html';}

// â”€â”€ LOAD â”€â”€
async function loadClients(){
  const{data}=await sb.from('clients').select('*').order('created_at',{ascending:false});
  clients=data||[];
  document.getElementById('nb-clients').textContent=clients.length;
  renderClients();
}
async function loadJobs(){
  const{data}=await sb.from('jobs').select('*,clients(name)').order('date',{ascending:false});
  jobs=data||[];
  renderJobs();
}
async function loadInvoices(){
  const{data}=await sb.from('invoices').select('*,clients(name)').order('created_at',{ascending:false});
  invoices=data||[];
  document.getElementById('nb-invoices').textContent=invoices.filter(i=>i.status==='pending').length;
  renderInvoices();
}

// â”€â”€ DASHBOARD â”€â”€
function renderDashboard(){
  const rev=clients.reduce((s,c)=>s+(c.total_billed||0),0);
  const pend=invoices.filter(i=>i.status==='pending');
  const pendAmt=pend.reduce((s,i)=>s+(i.amount||0),0);
  document.getElementById('s-revenue').textContent='$'+rev.toLocaleString();
  document.getElementById('s-clients').textContent=clients.length;
  document.getElementById('s-pending').textContent='$'+pendAmt.toLocaleString();
  document.getElementById('s-pending-sub').textContent=pend.length+' invoice'+(pend.length!==1?'s':'');
  document.getElementById('s-jobs').textContent=jobs.length;
  document.getElementById('d-clients').innerHTML=clients.length===0?empty('No clients yet'):
    clients.slice(0,4).map(c=>`<div class="c-row"><div class="c-av">${c.name.substring(0,2).toUpperCase()}</div><div style="flex:1;min-width:0"><div class="c-name">${c.name}</div><div class="c-meta">${c.courts||1} courts Â· ${c.location||'â€”'}</div></div>${stag(c.surface)}</div>`).join('');
  document.getElementById('d-jobs').innerHTML=jobs.length===0?empty('No jobs yet'):
    `<div class="tbl-wrap"><table class="tbl"><thead><tr><th>Client</th><th>Service</th><th>Amount</th><th>Status</th></tr></thead><tbody>`+
    jobs.slice(0,4).map(j=>`<tr><td><strong>${j.clients?.name||'?'}</strong></td><td>${j.service||'â€”'}</td><td><strong>$${(j.amount||0).toLocaleString()}</strong></td><td>${jbadge(j.status)}</td></tr>`).join('')+`</tbody></table></div>`;
  document.getElementById('d-invoices').innerHTML=invoices.length===0?empty('No invoices yet'):
    `<div class="tbl-wrap"><table class="tbl"><thead><tr><th>Client</th><th>Amount</th><th>Status</th></tr></thead><tbody>`+
    invoices.slice(0,5).map(i=>`<tr><td><strong>${i.clients?.name||'?'}</strong></td><td><strong>$${(i.amount||0).toLocaleString()}</strong></td><td>${ibadge(i.status)}</td></tr>`).join('')+`</tbody></table></div>`;
}

// â”€â”€ CLIENTS TABLE â”€â”€
function renderClients(){
  document.getElementById('clients-list').innerHTML=clients.length===0?empty('No clients yet â€” tap "Add Client" to get started'):
    `<table class="tbl"><thead><tr><th>Client</th><th>Location</th><th>Surface</th><th>Courts</th><th>Billed</th><th></th></tr></thead><tbody>`+
    clients.map(c=>`<tr>
      <td><div style="display:flex;align-items:center;gap:10px"><div class="c-av" style="width:30px;height:30px;font-size:11px;flex-shrink:0">${c.name.substring(0,2).toUpperCase()}</div><strong>${c.name}</strong></div></td>
      <td>${c.location||'â€”'}</td>
      <td>${stag(c.surface)}</td>
      <td>${c.courts||1}</td>
      <td><strong>$${(c.total_billed||0).toLocaleString()}</strong></td>
      <td><div class="row-actions">
        <button class="act-btn act-edit" onclick="editClient('${c.id}')">Edit</button>
        <button class="act-btn act-delete" onclick="confirmDelete('client','${c.id}','${c.name.replace(/'/g,"\\'")}')">Delete</button>
      </div></td>
    </tr>`).join('')+`</tbody></table>`;
}

// â”€â”€ JOBS TABLE â”€â”€
function renderJobs(){
  document.getElementById('jobs-list').innerHTML=jobs.length===0?empty('No jobs yet â€” tap "Add Job" to schedule one'):
    `<table class="tbl"><thead><tr><th>Client</th><th>Service</th><th>Date</th><th>Amount</th><th>Status</th><th></th></tr></thead><tbody>`+
    jobs.map(j=>`<tr>
      <td><strong>${j.clients?.name||'?'}</strong></td>
      <td>${j.service||'â€”'}</td>
      <td>${j.date?new Date(j.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'â€”'}</td>
      <td><strong>$${(j.amount||0).toLocaleString()}</strong></td>
      <td>${jbadge(j.status)}</td>
      <td><div class="row-actions">
        <button class="act-btn act-edit" onclick="editJob('${j.id}')">Edit</button>
        <button class="act-btn act-delete" onclick="confirmDelete('job','${j.id}','${(j.service||'job').replace(/'/g,"\\'")}')">Delete</button>
      </div></td>
    </tr>`).join('')+`</tbody></table>`;
}

// â”€â”€ INVOICES TABLE â”€â”€
function renderInvoices(){
  document.getElementById('invoices-list').innerHTML=invoices.length===0?empty('No invoices yet â€” tap "New Invoice" to create one'):
    `<table class="tbl"><thead><tr><th>Client</th><th>Amount</th><th>Date</th><th>Status</th><th></th></tr></thead><tbody>`+
    invoices.map(i=>`<tr>
      <td><strong>${i.clients?.name||'?'}</strong></td>
      <td><strong>$${(i.amount||0).toLocaleString()}</strong></td>
      <td>${i.issued_date?new Date(i.issued_date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'â€”'}</td>
      <td>${ibadge(i.status)}</td>
      <td><div class="row-actions">
        ${i.status!=='paid'?`<button class="act-btn act-paid" onclick="markPaid('${i.id}')">âœ“ Paid</button>`:''}
        <button class="act-btn act-edit" onclick="editInvoice('${i.id}')">Edit</button>
        <button class="act-btn act-delete" onclick="confirmDelete('invoice','${i.id}','$${(i.amount||0).toLocaleString()} invoice')">Delete</button>
      </div></td>
    </tr>`).join('')+`</tbody></table>`;
}

// â”€â”€ MARK AS PAID â”€â”€
async function markPaid(id){
  const{error}=await sb.from('invoices').update({status:'paid'}).eq('id',id);
  if(error){toast('Error: '+error.message,'err');return;}
  toast('Invoice marked as paid! ðŸ’°','ok');
  await loadInvoices();renderDashboard();
}

// â”€â”€ EDIT CLIENT â”€â”€
function editClient(id){
  const c=clients.find(x=>x.id===id);if(!c)return;
  editingId.client=id;
  document.getElementById('client-modal-title').textContent='Edit Client';
  document.getElementById('client-modal-sub').textContent='Changes save immediately';
  document.getElementById('c-name').value=c.name||'';
  document.getElementById('c-loc').value=c.location||'';
  document.getElementById('c-surface').value=c.surface||'';
  document.getElementById('c-courts').value=c.courts||1;
  document.getElementById('c-notes').value=c.notes||'';
  document.getElementById('save-client-btn').textContent='Save Changes';
  document.getElementById('m-client').classList.add('open');
}

// â”€â”€ EDIT JOB â”€â”€
function editJob(id){
  const j=jobs.find(x=>x.id===id);if(!j)return;
  editingId.job=id;
  document.getElementById('job-modal-title').textContent='Edit Job';
  document.getElementById('job-modal-sub').textContent='Changes save immediately';
  const sel=document.getElementById('j-client');
  sel.innerHTML='<option value="">Select client</option>'+clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  sel.value=j.client_id||'';
  document.getElementById('j-service').value=j.service||'';
  document.getElementById('j-date').value=j.date||'';
  document.getElementById('j-amount').value=j.amount||'';
  document.getElementById('j-status').value=j.status||'scheduled';
  document.getElementById('save-job-btn').textContent='Save Changes';
  document.getElementById('m-job').classList.add('open');
}

// â”€â”€ EDIT INVOICE â”€â”€
function editInvoice(id){
  const i=invoices.find(x=>x.id===id);if(!i)return;
  editingId.invoice=id;
  document.getElementById('invoice-modal-title').textContent='Edit Invoice';
  document.getElementById('invoice-modal-sub').textContent='Changes save immediately';
  const sel=document.getElementById('i-client');
  sel.innerHTML='<option value="">Select client</option>'+clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  sel.value=i.client_id||'';
  document.getElementById('i-amount').value=i.amount||'';
  document.getElementById('i-status').value=i.status||'pending';
  document.getElementById('save-invoice-btn').textContent='Save Changes';
  document.getElementById('m-invoice').classList.add('open');
}

// â”€â”€ SAVE CLIENT (add or edit) â”€â”€
async function saveClient(){
  const name=document.getElementById('c-name').value.trim();
  if(!name){toast('Enter a client name','err');return;}
  const btn=document.getElementById('save-client-btn');
  btn.disabled=true;btn.textContent='Saving...';
  const payload={name,location:document.getElementById('c-loc').value.trim(),surface:document.getElementById('c-surface').value,courts:parseInt(document.getElementById('c-courts').value)||1,notes:document.getElementById('c-notes').value.trim()};
  let error;
  if(editingId.client){
    ({error}=await sb.from('clients').update(payload).eq('id',editingId.client));
  } else {
    ({error}=await sb.from('clients').insert(payload));
  }
  btn.disabled=false;btn.textContent=editingId.client?'Save Changes':'Save Client';
  if(error){toast('Error: '+error.message,'err');return;}
  closeModal('client');
  toast(editingId.client?'Client updated!':'Client saved!','ok');
  await loadClients();renderDashboard();
}

// â”€â”€ SAVE JOB (add or edit) â”€â”€
async function saveJob(){
  const cid=document.getElementById('j-client').value;
  const svc=document.getElementById('j-service').value.trim();
  if(!cid||!svc){toast('Please fill in all fields','err');return;}
  const btn=document.getElementById('save-job-btn');
  btn.disabled=true;btn.textContent='Saving...';
  const payload={client_id:cid,service:svc,date:document.getElementById('j-date').value,amount:parseFloat(document.getElementById('j-amount').value)||0,status:document.getElementById('j-status').value};
  let error;
  if(editingId.job){
    ({error}=await sb.from('jobs').update(payload).eq('id',editingId.job));
  } else {
    ({error}=await sb.from('jobs').insert(payload));
  }
  btn.disabled=false;btn.textContent=editingId.job?'Save Changes':'Save Job';
  if(error){toast('Error: '+error.message,'err');return;}
  closeModal('job');
  toast(editingId.job?'Job updated!':'Job saved!','ok');
  await loadJobs();renderDashboard();
}

// â”€â”€ SAVE INVOICE (add or edit) â”€â”€
async function saveInvoice(){
  const cid=document.getElementById('i-client').value;
  const amt=parseFloat(document.getElementById('i-amount').value);
  if(!cid||!amt){toast('Please fill in all fields','err');return;}
  const btn=document.getElementById('save-invoice-btn');
  btn.disabled=true;btn.textContent='Saving...';
  const payload={client_id:cid,amount:amt,status:document.getElementById('i-status').value};
  let error;
  if(editingId.invoice){
    ({error}=await sb.from('invoices').update(payload).eq('id',editingId.invoice));
  } else {
    ({error}=await sb.from('invoices').insert(payload));
  }
  btn.disabled=false;btn.textContent=editingId.invoice?'Save Changes':'Save Invoice';
  if(error){toast('Error: '+error.message,'err');return;}
  closeModal('invoice');
  toast(editingId.invoice?'Invoice updated!':'Invoice created!','ok');
  await loadInvoices();renderDashboard();
}

// â”€â”€ DELETE â”€â”€
let pendingDelete={type:null,id:null};
function confirmDelete(type,id,label){
  pendingDelete={type,id};
  document.getElementById('confirm-msg').textContent=`Delete "${label}"? This cannot be undone.`;
  document.getElementById('confirm-overlay').classList.add('open');
  document.getElementById('confirm-ok-btn').onclick=doDelete;
}
function closeConfirm(){document.getElementById('confirm-overlay').classList.remove('open');pendingDelete={type:null,id:null};}
async function doDelete(){
  const{type,id}=pendingDelete;
  closeConfirm();
  const{error}=await sb.from(type==='client'?'clients':type==='job'?'jobs':'invoices').delete().eq('id',id);
  if(error){toast('Error: '+error.message,'err');return;}
  toast('Deleted','ok');
  if(type==='client'){await loadClients();}
  else if(type==='job'){await loadJobs();}
  else{await loadInvoices();}
  renderDashboard();
}

// â”€â”€ MODALS â”€â”€
function openModal(type){
  editingId[type]=null;
  // Reset titles
  if(type==='client'){document.getElementById('client-modal-title').textContent='Add Client';document.getElementById('client-modal-sub').textContent='';document.getElementById('save-client-btn').textContent='Save Client';['c-name','c-loc','c-courts','c-notes'].forEach(id=>document.getElementById(id).value='');document.getElementById('c-surface').value='';}
  if(type==='job'){document.getElementById('job-modal-title').textContent='Add Job';document.getElementById('job-modal-sub').textContent='';document.getElementById('save-job-btn').textContent='Save Job';const el=document.getElementById('j-client');el.innerHTML='<option value="">Select client</option>'+clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');}
  if(type==='invoice'){document.getElementById('invoice-modal-title').textContent='New Invoice';document.getElementById('invoice-modal-sub').textContent='';document.getElementById('save-invoice-btn').textContent='Save Invoice';const el=document.getElementById('i-client');el.innerHTML='<option value="">Select client</option>'+clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');}
  document.getElementById('m-'+type).classList.add('open');
}
function closeModal(type){document.getElementById('m-'+type).classList.remove('open');editingId[type]=null;}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o){const t=o.id.replace('m-','');closeModal(t);}}));

// â”€â”€ NAV â”€â”€
function nav(name,el){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  if(el)el.classList.add('active');
  else document.querySelector(`.nav-item[onclick*="'${name}'"]`)?.classList.add('active');
  closeSidebar();window.scrollTo(0,0);
}
function openSidebar(){document.getElementById('sidebar').classList.add('open');document.getElementById('sidebar-overlay').classList.add('open');}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebar-overlay').classList.remove('open');}

// â”€â”€ HELPERS â”€â”€
function stag(s){const m={'Har-Tru':'tag-hartru','Hard':'tag-hard','Hard Court':'tag-hard','Red Clay':'tag-clay'};return`<span class="tag ${m[s]||'tag-def'}">${s||'â€”'}</span>`;}
function jbadge(s){const m={scheduled:'b-scheduled',completed:'b-completed',cancelled:'b-cancelled'};return`<span class="badge ${m[s]||'b-scheduled'}">${s||'scheduled'}</span>`;}
function ibadge(s){const m={paid:'b-paid',pending:'b-pending',overdue:'b-overdue'};return`<span class="badge ${m[s]||'b-pending'}">${s||'pending'}</span>`;}
function empty(msg){return`<div class="empty"><p>${msg}</p></div>`;}
function toast(msg,type='ok'){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show'+(type==='ok'?' ok':'');setTimeout(()=>t.className='toast',3000);}
</script>
</body>
</html>
