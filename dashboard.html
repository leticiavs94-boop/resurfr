<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resurfr ‚Äî Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800;900&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--yellow:#C8E62B;--ydim:rgba(200,230,43,0.12);--green:#1E4D35;--glight:#4CAF80;--off:#F4F6F1;--border:#E2E8DC;--charcoal:#181C17;--text:#1A1F18;--muted:#6B7A65;--lmuted:#9DAA96;--sw:240px;}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{height:100%}
body{font-family:'DM Sans',sans-serif;background:var(--off);color:var(--text);min-height:100vh}
#loading-screen{position:fixed;inset:0;background:var(--charcoal);display:flex;align-items:center;justify-content:center;z-index:999;flex-direction:column;gap:16px}
#loading-screen .logo{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:900;color:white}
#loading-screen .spin{width:24px;height:24px;border:3px solid rgba(255,255,255,0.2);border-top-color:var(--yellow);border-radius:50%;animation:spin .7s linear infinite}
#app{display:none}
@keyframes spin{to{transform:rotate(360deg)}}
.layout{display:flex;min-height:100vh}
.sidebar{width:var(--sw);background:var(--charcoal);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;transition:transform .3s}
.sidebar-logo{padding:20px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,0.07);margin-bottom:8px}
.logo-badge{background:var(--yellow);border-radius:8px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.logo-text{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;color:white}
.nav-label{font-size:9px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:rgba(255,255,255,0.2);padding:10px 20px 4px}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 20px;margin:1px 8px;border-radius:8px;font-size:13px;font-weight:500;color:rgba(255,255,255,0.45);cursor:pointer;transition:all .2s;border:1px solid transparent;user-select:none;text-decoration:none}
.nav-item svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0}
.nav-item:hover{background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.8)}
.nav-item.active{background:var(--ydim);color:var(--yellow);border-color:rgba(200,230,43,0.2)}
.nav-item.active svg{stroke:var(--yellow)}
.nav-badge{margin-left:auto;background:var(--yellow);color:var(--charcoal);font-size:9px;font-weight:800;border-radius:10px;padding:1px 6px;line-height:1.4}
.sidebar-footer{margin-top:auto;padding:16px;border-top:1px solid rgba(255,255,255,0.07)}
.user-card{display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(255,255,255,0.05);border-radius:10px}
.user-av{width:32px;height:32px;border-radius:8px;background:var(--green);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;color:white;flex-shrink:0}
.user-name{font-size:12px;font-weight:600;color:rgba(255,255,255,0.8);line-height:1.2;word-break:break-all}
.sign-out{font-size:10px;color:rgba(255,255,255,0.3);cursor:pointer;margin-top:2px;transition:color .2s}
.sign-out:hover{color:rgba(255,255,255,0.6)}
.main{margin-left:var(--sw);flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{background:white;border-bottom:1px solid var(--border);padding:0 24px;height:56px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;flex-shrink:0}
.topbar-left{display:flex;align-items:center;gap:12px}
.menu-btn{display:none;background:none;border:none;cursor:pointer;padding:4px;color:var(--charcoal)}
.menu-btn svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round}
.page-title{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--charcoal)}
.topbar-right{display:flex;align-items:center;gap:8px}
.btn{padding:8px 16px;border-radius:7px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .2s;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
.btn svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2.5;stroke-linecap:round}
.btn-yellow{background:var(--yellow);color:var(--charcoal)}.btn-yellow:hover{background:#d4f030}
.btn-ghost{background:var(--off);color:var(--muted);border:1px solid var(--border)}
.content{padding:20px 24px;flex:1}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.stat{background:white;border:1px solid var(--border);border-radius:12px;padding:18px 20px;position:relative;overflow:hidden}
.stat::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.stat.s1::before{background:var(--yellow)}.stat.s2::before{background:var(--glight)}.stat.s3::before{background:#F0B429}.stat.s4::before{background:var(--green)}
.stat-lbl{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--lmuted);margin-bottom:6px}
.stat-val{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:900;color:var(--charcoal);line-height:1;margin-bottom:4px}
.stat-sub{font-size:11px;color:var(--lmuted)}
.panel{background:white;border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:16px}
.panel-head{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
.panel-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;color:var(--charcoal)}
.panel-link{font-size:11px;font-weight:600;color:var(--green);cursor:pointer;background:none;border:none;font-family:'DM Sans',sans-serif}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.tbl{width:100%;border-collapse:collapse}
.tbl th{padding:9px 16px;text-align:left;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--lmuted);background:var(--off);border-bottom:1px solid var(--border)}
.tbl td{padding:11px 16px;border-bottom:1px solid var(--border);font-size:13px;color:var(--text);vertical-align:middle}
.tbl tr:last-child td{border-bottom:none}
.tbl tbody tr:hover td{background:#FAFFF8}
.tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
.c-row{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);gap:10px}
.c-row:last-child{border-bottom:none}
.c-av{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:800;flex-shrink:0;background:#E8F2EC;color:var(--green)}
.c-name{font-size:13px;font-weight:600;color:var(--charcoal)}
.c-meta{font-size:11px;color:var(--lmuted);margin-top:1px}
.tag{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;letter-spacing:0.5px;white-space:nowrap}
.tag-hard{background:#FDF3E0;color:#B8842A}.tag-hartru{background:#E8F5EE;color:#2A7A52}.tag-clay{background:#FDEEE8;color:#A84E2A}.tag-def{background:var(--off);color:var(--muted)}
.badge{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;white-space:nowrap}
.b-paid{background:#E8F5EE;color:#2A7A52}.b-pending{background:#FFF8E6;color:#B88000}.b-overdue{background:#FDEEE8;color:#A84E2A}.b-scheduled{background:#EEF0FF;color:#3040C0}.b-completed{background:#E8F5EE;color:#2A7A52}.b-cancelled{background:var(--off);color:var(--muted);border:1px solid var(--border)}
.empty{padding:40px 20px;text-align:center;color:var(--lmuted)}
.empty p{font-size:13px;margin-top:8px}
.view{display:none}.view.active{display:block}

/* Row action buttons */
.row-actions{display:flex;align-items:center;gap:6px;opacity:0;transition:opacity .15s}
.tbl tbody tr:hover .row-actions{opacity:1}
.act-btn{padding:4px 10px;border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;border:none;font-family:‚ÄòDM Sans‚Äô,sans-serif;transition:all .15s;white-space:nowrap}
.act-edit{background:var(‚Äìoff);color:var(‚Äìmuted);border:1px solid var(‚Äìborder)}
.act-edit:hover{border-color:var(‚Äìcharcoal);color:var(‚Äìcharcoal)}
.act-delete{background:#FDF0EE;color:#A84E2A;border:1px solid #F5D4CF}
.act-delete:hover{background:#FDEEE8}
.act-paid{background:#E8F5EE;color:#2A7A52;border:1px solid #C8E8D8}
.act-paid:hover{background:#D4EEE0}
/* Always show on mobile */
@media(max-width:768px){.row-actions{opacity:1}}

/* Modal */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:200;display:none;align-items:flex-end;justify-content:center}
.overlay.open{display:flex}
.modal{background:white;border-radius:20px 20px 0 0;padding:24px 20px 32px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto}
.modal-title{font-family:‚ÄòBarlow Condensed‚Äô,sans-serif;font-size:22px;font-weight:800;color:var(‚Äìcharcoal);margin-bottom:4px}

.fg{margin-bottom:12px}
.fl{display:block;font-size:10px;font-weight:700;letter-spacing:0.5px;color:var(‚Äìlmuted);margin-bottom:4px;text-transform:uppercase}
.fi{width:100%;padding:10px 14px;border:1.5px solid var(‚Äìborder);border-radius:8px;font-family:‚ÄòDM Sans‚Äô,sans-serif;font-size:15px;color:var(‚Äìcharcoal);outline:none;transition:border-color .2s;background:var(‚Äìoff);-webkit-appearance:none}
.fi:focus{border-color:var(‚Äìgreen);background:white}
.fi::placeholder{color:#C8D0C2}
.modal-btns{display:flex;gap:10px;margin-top:18px}
.modal-btns button{flex:1;padding:13px;border-radius:8px;font-family:‚ÄòDM Sans‚Äô,sans-serif;font-size:14px;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.b-cancel{background:var(‚Äìoff);color:var(‚Äìmuted);border:1px solid var(‚Äìborder)}
.b-save{background:var(‚Äìyellow);color:var(‚Äìcharcoal)}.b-save:hover{background:#d4f030}.b-save:disabled{opacity:0.6;cursor:not-allowed}
.b-danger{background:#FDEEE8;color:#A84E2A;border:1px solid #F5D4CF}.b-danger:hover{background:#F9E0DA}

/* Confirm dialog */
.confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:300;display:none;align-items:center;justify-content:center;padding:20px}
.confirm-overlay.open{display:flex}
.confirm-box{background:white;border-radius:16px;padding:28px 24px;max-width:360px;width:100%;text-align:center}
.confirm-title{font-family:‚ÄòBarlow Condensed‚Äô,sans-serif;font-size:22px;font-weight:800;color:var(‚Äìcharcoal);margin-bottom:8px}
.confirm-msg{font-size:14px;color:var(‚Äìmuted);margin-bottom:24px;line-height:1.5}
.confirm-btns{display:flex;gap:10px}
.confirm-btns button{flex:1;padding:12px;border-radius:8px;font-family:‚ÄòDM Sans‚Äô,sans-serif;font-size:14px;font-weight:600;cursor:pointer;border:none;transition:all .2s}

.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(‚Äìcharcoal);color:white;padding:12px 24px;border-radius:10px;font-size:13px;font-weight:500;z-index:400;opacity:0;transition:all .3s;white-space:nowrap}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}.toast.ok{background:var(‚Äìgreen)}
.spinner{width:14px;height:14px;border:2px solid var(‚Äìborder);border-top-color:var(‚Äìgreen);border-radius:50%;animation:spin .6s linear infinite;flex-shrink:0}
.loading{display:flex;align-items:center;justify-content:center;gap:8px;padding:32px;color:var(‚Äìlmuted);font-size:13px}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99}
.m-card{background:white;border-bottom:1px solid var(‚Äìborder);padding:14px 16px;display:none}
.m-card:last-child{border-bottom:none}
.m-card-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:4px;gap:8px}
.m-card-name{font-size:14px;font-weight:700;color:var(‚Äìcharcoal);line-height:1.3}
.m-card-amount{font-size:14px;font-weight:700;color:var(‚Äìcharcoal);white-space:nowrap}
.m-card-meta{font-size:12px;color:var(‚Äìlmuted);margin-bottom:8px;line-height:1.4}
.m-card-tags{display:flex;align-items:center;gap:5px;flex-wrap:wrap;margin-bottom:10px}
.m-card-actions{display:flex;gap:6px;flex-wrap:wrap}
.m-card-actions .act-btn{padding:8px 14px;font-size:12px;border-radius:6px}
@media(max-width:768px){
.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}
.sidebar-overlay.open{display:block}.main{margin-left:0}.menu-btn{display:flex}
.stats{grid-template-columns:1fr 1fr}.grid2{grid-template-columns:1fr}
.content{padding:14px}.topbar{padding:0 14px}
.topbar-date{display:none}
.desktop-table{display:none}
.m-card{display:block}
}
@media(max-width:400px){.stats{grid-template-columns:1fr}.stat-val{font-size:28px}}
</style>

</head>
<body>

<div id="loading-screen"><div class="logo">Resurfr</div><div class="spin"></div></div>
<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

<div id="app">
<div class="layout">

<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-badge">
      <svg width="20" height="20" viewBox="0 0 40 40" fill="none">
        <rect x="2" y="5" width="36" height="30" rx="3.5" fill="rgba(26,31,24,0.08)" stroke="#1A1F18" stroke-width="2.2"/>
        <line x1="2" y1="20" x2="38" y2="20" stroke="#1A1F18" stroke-width="2.5"/>
        <line x1="20" y1="5" x2="20" y2="35" stroke="#1A1F18" stroke-width="1.5"/>
        <line x1="10" y1="5" x2="10" y2="20" stroke="#1A1F18" stroke-width="1.2"/>
        <line x1="30" y1="5" x2="30" y2="20" stroke="#1A1F18" stroke-width="1.2"/>
        <path d="M2 27 Q11 22 20 27 Q29 32 38 27" stroke="#1A1F18" stroke-width="2.5" stroke-linecap="round" fill="none"/>
      </svg>
    </div>
    <span class="logo-text">Resurfr</span>
  </div>
  <div class="nav-label">Main</div>
  <div class="nav-item active" onclick="nav('dashboard',this)">
    <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
    Dashboard
  </div>
  <div class="nav-item" onclick="nav('clients',this)">
    <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    Clients <span class="nav-badge" id="nb-clients">0</span>
  </div>
  <div class="nav-item" onclick="nav('jobs',this)">
    <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    Jobs
  </div>
  <div class="nav-label" style="margin-top:8px">Finance</div>
  <div class="nav-item" onclick="nav('invoices',this)">
    <svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
    Invoices <span class="nav-badge" id="nb-invoices">0</span>
  </div>
  <div class="nav-label" style="margin-top:8px">Tools</div>
  <a class="nav-item" href="/map.html">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="10" r="3"/><path d="M12 2a8 8 0 0 0-8 8c0 5.4 7.05 11.5 7.65 12 .19.16.51.16.7 0C12.95 21.5 20 15.4 20 10a8 8 0 0 0-8-8z"/></svg>
    Court Map
  </a>
  <div class="sidebar-footer">
    <div class="user-card">
      <div class="user-av" id="user-av">?</div>
      <div style="min-width:0">
        <div class="user-name" id="user-email">Loading...</div>
        <div class="sign-out" onclick="signOut()">Sign out</div>
      </div>
    </div>
  </div>
</aside>

<div class="main">

  <!-- DASHBOARD -->

  <div id="view-dashboard" class="view active">
    <div class="topbar">
      <div class="topbar-left">
        <button class="menu-btn" onclick="openSidebar()"><svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
        <div>
          <div class="page-title" id="dash-greeting">Good morning</div>
          <div class="topbar-date" id="today-date" style="font-size:11px;color:var(--lmuted);margin-top:1px"></div>
        </div>
      </div>
      <div class="topbar-right">
        <button class="btn btn-yellow" onclick="openModal('client')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add Client</button>
      </div>
    </div>
    <div class="content">
      <div class="stats">
        <div class="stat s1"><div class="stat-lbl">YTD Revenue</div><div class="stat-val" id="s-revenue">$0</div><div class="stat-sub" id="s-revenue-sub">this year</div></div>
        <div class="stat s2"><div class="stat-lbl">Active Clients</div><div class="stat-val" id="s-clients">0</div><div class="stat-sub" id="s-clients-sub">0 courts</div></div>
        <div class="stat s3"><div class="stat-lbl">Pending Invoices</div><div class="stat-val" id="s-pending">$0</div><div class="stat-sub" id="s-pending-sub">0 unpaid</div></div>
        <div class="stat s4"><div class="stat-lbl">Jobs This Month</div><div class="stat-val" id="s-month">0</div><div class="stat-sub" id="s-month-sub">$0 revenue</div></div>
      </div>
      <!-- Upcoming + Service Alerts side by side on desktop -->
      <div class="grid2" style="margin-bottom:16px">
        <div class="panel">
          <div class="panel-head">
            <div style="display:flex;align-items:center;gap:8px">
              <div class="panel-title">Upcoming Jobs</div>
              <span id="upcoming-count" style="background:var(--yellow);color:var(--charcoal);font-size:9px;font-weight:800;border-radius:10px;padding:1px 7px;line-height:1.6"></span>
            </div>
            <button class="panel-link" onclick="nav('jobs',null)">View all</button>
          </div>
          <div id="d-upcoming"><div class="loading"><div class="spinner"></div>Loading...</div></div>
        </div>
        <div class="panel">
          <div class="panel-head">
            <div style="display:flex;align-items:center;gap:8px">
              <div class="panel-title">‚ö†Ô∏è Service Alerts</div>
              <span id="alerts-count" style="background:#FDEEE8;color:#A84E2A;font-size:9px;font-weight:800;border-radius:10px;padding:1px 7px;line-height:1.6;display:none"></span>
            </div>
            <a href="/map.html" style="font-size:11px;font-weight:600;color:var(--green);text-decoration:none">Open Map</a>
          </div>
          <div id="d-alerts"><div class="loading"><div class="spinner"></div>Loading...</div></div>
        </div>
      </div>
      <div class="grid2">
        <div class="panel">
          <div class="panel-head">
            <div style="display:flex;align-items:center;gap:8px">
              <div class="panel-title">Outstanding Invoices</div>
              <span id="overdue-count" style="background:#FDEEE8;color:#A84E2A;font-size:9px;font-weight:800;border-radius:10px;padding:1px 7px;line-height:1.6;display:none">overdue</span>
            </div>
            <button class="panel-link" onclick="nav('invoices',null)">View all</button>
          </div>
          <div id="d-invoices"><div class="loading"><div class="spinner"></div>Loading...</div></div>
        </div>
        <div class="panel">
          <div class="panel-head"><div class="panel-title">Active Clients</div><button class="panel-link" onclick="nav('clients',null)">View all</button></div>
          <div id="d-clients"><div class="loading"><div class="spinner"></div>Loading...</div></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-head"><div class="panel-title">Recently Completed</div><button class="panel-link" onclick="nav('jobs',null)">View all</button></div>
        <div id="d-completed"><div class="loading"><div class="spinner"></div>Loading...</div></div>
      </div>
      <div class="panel" id="followups-panel" style="display:none">
        <div class="panel-head">
          <div style="display:flex;align-items:center;gap:8px">
            <div class="panel-title">üîî Follow-ups Due</div>
            <span id="fu-count" style="background:#FDEEE8;color:#A84E2A;font-size:9px;font-weight:800;border-radius:10px;padding:1px 7px;line-height:1.6"></span>
          </div>
          <a href="/map.html" style="font-size:11px;font-weight:600;color:var(--green);text-decoration:none">Open Map</a>
        </div>
        <div id="d-followups"></div>
      </div>
    </div>
  </div>

  <!-- CLIENTS -->

  <div id="view-clients" class="view">
    <div class="topbar">
      <div class="topbar-left"><button class="menu-btn" onclick="openSidebar()"><svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="page-title">Clients</div></div>
      <button class="btn btn-yellow" onclick="openModal('client')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add Client</button>
    </div>
    <div class="content"><div class="panel"><div class="tbl-wrap"><div id="clients-list"><div class="loading"><div class="spinner"></div>Loading...</div></div></div></div></div>
  </div>

  <!-- JOBS -->

  <div id="view-jobs" class="view">
    <div class="topbar">
      <div class="topbar-left"><button class="menu-btn" onclick="openSidebar()"><svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="page-title">Jobs</div></div>
      <button class="btn btn-yellow" onclick="openModal('job')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add Job</button>
    </div>
    <div class="content"><div class="panel"><div class="tbl-wrap"><div id="jobs-list"><div class="loading"><div class="spinner"></div>Loading...</div></div></div></div></div>
  </div>

  <!-- INVOICES -->

  <div id="view-invoices" class="view">
    <div class="topbar">
      <div class="topbar-left"><button class="menu-btn" onclick="openSidebar()"><svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="page-title">Invoices</div></div>
      <button class="btn btn-yellow" onclick="openModal('invoice')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>New Invoice</button>
    </div>
    <div class="content"><div class="panel"><div class="tbl-wrap"><div id="invoices-list"><div class="loading"><div class="spinner"></div>Loading...</div></div></div></div></div>
  </div>

</div>
</div>
</div>

<!-- QUICK ADD MODAL v5 -->

<div class="overlay" id="m-client">
  <div class="modal">
    <div class="modal-title" id="client-modal-title">Add Client</div>

```
<!-- Step indicators -->
<div id="qa-steps" style="display:none;margin-bottom:20px;margin-top:4px">
  <div style="display:flex;align-items:center">
    <div id="step-1" style="flex:1;text-align:center;padding:8px 4px;border-bottom:2px solid var(--charcoal);font-size:11px;font-weight:700;color:var(--charcoal)">1 ¬∑ Client</div>
    <div id="step-2" style="flex:1;text-align:center;padding:8px 4px;border-bottom:2px solid var(--border);font-size:11px;font-weight:700;color:var(--lmuted)">2 ¬∑ Job</div>
    <div id="step-3" style="flex:1;text-align:center;padding:8px 4px;border-bottom:2px solid var(--border);font-size:11px;font-weight:700;color:var(--lmuted)">3 ¬∑ Invoice</div>
  </div>
</div>

<!-- Page 1: Client info -->
<div id="qa-page-1">
  <div class="fg"><label class="fl">Facility Name *</label><input type="text" class="fi" id="c-name" placeholder="Westport Tennis Club"></div>
  <div class="fg"><label class="fl">Location</label><input type="text" class="fi" id="c-loc" placeholder="Westport, CT"></div>
  <div class="fg"><label class="fl">Surface Type</label>
    <select class="fi" id="c-surface"><option value="">Select surface</option><option value="Har-Tru">Har-Tru</option><option value="Hard">Hard Court</option><option value="Red Clay">Red Clay</option></select>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
    <div class="fg"><label class="fl">Courts</label><input type="number" class="fi" id="c-courts" placeholder="4" min="1"></div>
    <div class="fg"><label class="fl">Status</label>
      <select class="fi" id="c-status">
        <option value="active">Active Client</option>
        <option value="prospect">Prospect</option>
        <option value="inactive">Inactive</option>
      </select>
    </div>
  </div>
  <div class="fg"><label class="fl">Notes</label><input type="text" class="fi" id="c-notes" placeholder="Optional notes..."></div>
  <div class="modal-btns" id="edit-client-btns" style="display:none">
    <button class="b-cancel" onclick="closeModal('client')">Cancel</button>
    <button class="b-save" id="save-client-btn" onclick="saveClient()">Save Client</button>
  </div>
  <div id="qa-new-btns" style="margin-top:4px">
    <button style="width:100%;padding:13px;border-radius:8px;background:var(--yellow);color:var(--charcoal);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;border:none;margin-bottom:8px" onclick="saveClient()">Save &amp; Add Job ‚Üí</button>
    <button style="width:100%;padding:11px;border-radius:8px;background:var(--charcoal);color:white;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;border:none;margin-bottom:8px" onclick="saveClientOnly()">Save Client Only</button>
    <button style="width:100%;padding:9px;border-radius:8px;background:none;border:none;font-size:13px;color:var(--lmuted);cursor:pointer;font-family:'DM Sans',sans-serif" onclick="closeModal('client')">Cancel</button>
  </div>
</div>

<!-- Page 2: Job -->
<div id="qa-page-2" style="display:none">
  <div style="background:#E8F5EE;border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:13px;color:var(--green);font-weight:600">‚úì Client saved! Now add a job for <span id="qa-client-name-display"></span></div>
  <div class="fg"><label class="fl">Service</label><input type="text" class="fi" id="qa-j-service" placeholder="Har-Tru topdressing"></div>
  <div class="fg"><label class="fl">Date</label><input type="date" class="fi" id="qa-j-date"></div>
  <div class="fg"><label class="fl">Amount ($)</label><input type="number" class="fi" id="qa-j-amount" placeholder="3800"></div>
  <div class="fg"><label class="fl">Job Status</label>
    <select class="fi" id="qa-j-status"><option value="scheduled">Scheduled</option><option value="completed">Completed</option><option value="cancelled">Cancelled</option></select>
  </div>
  <button style="width:100%;padding:13px;border-radius:8px;background:var(--yellow);color:var(--charcoal);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;border:none;margin-bottom:8px" onclick="qaNext(3)">Save Job &amp; Add Invoice ‚Üí</button>
  <button style="width:100%;padding:11px;border-radius:8px;background:var(--charcoal);color:white;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;border:none;margin-bottom:8px" onclick="qaFinish(true,false)">Save Job &amp; Finish</button>
  <button style="width:100%;padding:9px;border-radius:8px;background:none;border:none;font-size:13px;color:var(--lmuted);cursor:pointer;font-family:'DM Sans',sans-serif" onclick="qaFinish(false,false)">Skip ‚Äî finish without job</button>
</div>

<!-- Page 3: Invoice -->
<div id="qa-page-3" style="display:none">
  <div style="background:#E8F5EE;border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:13px;color:var(--green);font-weight:600">‚úì Job saved! Create an invoice for <span id="qa-client-name-display2"></span>?</div>
  <div class="fg">
    <label class="fl">Invoice Amount ($)</label>
    <input type="number" class="fi" id="i-amount" placeholder="0">
    <div style="font-size:11px;color:var(--lmuted);margin-top:4px">Pre-filled from job ‚Äî edit if different</div>
  </div>
  <div class="fg"><label class="fl">Payment Status</label>
    <select class="fi" id="i-status">
      <option value="pending">Pending ‚Äî not yet paid</option>
      <option value="paid">Paid ‚úì</option>
      <option value="overdue">Overdue</option>
    </select>
  </div>
  <button style="width:100%;padding:13px;border-radius:8px;background:var(--yellow);color:var(--charcoal);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;border:none;margin-bottom:8px" id="qa-finish-btn" onclick="qaFinish(false,true)">Save Invoice &amp; Finish ‚úì</button>
  <button style="width:100%;padding:9px;border-radius:8px;background:none;border:none;font-size:13px;color:var(--lmuted);cursor:pointer;font-family:'DM Sans',sans-serif" onclick="qaFinish(false,false)">Skip ‚Äî finish without invoice</button>
</div>
```

  </div>
</div>

<!-- JOB MODAL -->

<div class="overlay" id="m-job">
  <div class="modal">
    <div class="modal-title" id="job-modal-title">Add Job</div>
    <div class="modal-sub" id="job-modal-sub" style="display:none"></div>
    <div class="fg"><label class="fl">Client</label><select class="fi" id="j-client"></select></div>
    <div class="fg"><label class="fl">Service</label><input type="text" class="fi" id="j-service" placeholder="Har-Tru topdressing"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="fg"><label class="fl">Date</label><input type="date" class="fi" id="j-date"></div>
      <div class="fg"><label class="fl">Amount ($)</label><input type="number" class="fi" id="j-amount" placeholder="3800"></div>
    </div>
    <div class="fg"><label class="fl">Status</label>
      <select class="fi" id="j-status"><option value="scheduled">Scheduled</option><option value="completed">Completed</option><option value="cancelled">Cancelled</option></select>
    </div>
    <div class="fg"><label class="fl">Notes</label><input type="text" class="fi" id="j-notes" placeholder="What was done, materials used, condition..."></div>
    <div class="fg">
      <label class="fl">Next Visit Date <span style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--lmuted)">(when to return)</span></label>
      <input type="date" class="fi" id="j-next-visit">
    </div>
    <div class="modal-btns">
      <button class="b-cancel" onclick="closeModal('job')">Cancel</button>
      <button class="b-save" id="save-job-btn" onclick="saveJob()">Save Job</button>
    </div>
  </div>
</div>

<!-- INVOICE MODAL -->

<div class="overlay" id="m-invoice">
  <div class="modal">
    <div class="modal-title" id="invoice-modal-title">New Invoice</div>
    <div class="modal-sub" id="invoice-modal-sub" style="display:none"></div>
    <div class="fg"><label class="fl">Client</label><select class="fi" id="i-client"></select></div>
    <div class="fg"><label class="fl">Amount ($)</label><input type="number" class="fi" id="i-amount" placeholder="3800"></div>
    <div class="fg"><label class="fl">Status</label>
      <select class="fi" id="i-status"><option value="pending">Pending</option><option value="paid">Paid</option><option value="overdue">Overdue</option></select>
    </div>
    <div class="modal-btns">
      <button class="b-cancel" onclick="closeModal('invoice')">Cancel</button>
      <button class="b-save" id="save-invoice-btn" onclick="saveInvoice()">Save Invoice</button>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE -->

<div id="confirm-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:600;align-items:center;justify-content:center;padding:20px">
  <div style="background:white;border-radius:20px;padding:28px 24px;max-width:340px;width:100%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
    <div style="font-size:32px;margin-bottom:12px">üóëÔ∏è</div>
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--charcoal);margin-bottom:8px">Are you sure?</div>
    <div id="confirm-msg" style="font-size:13px;color:var(--muted);margin-bottom:24px;line-height:1.5">This cannot be undone.</div>
    <div style="display:flex;gap:10px">
      <button onclick="closeConfirm()" style="flex:1;padding:14px;border-radius:10px;background:var(--off);color:var(--charcoal);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;border:1px solid var(--border)">Cancel</button>
      <button id="confirm-ok-btn" style="flex:1;padding:14px;border-radius:10px;background:#C0392B;color:white;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;border:none">Yes, Delete</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- CLIENT DETAIL OVERLAY -->

<div id="client-detail-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:500;align-items:flex-end;justify-content:center">
  <div style="background:white;border-radius:20px 20px 0 0;width:100%;max-width:600px;max-height:88vh;overflow-y:auto;padding-bottom:40px">
    <div style="padding:16px 20px 0;display:flex;justify-content:space-between;align-items:center">
      <div style="width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 4px"></div>
    </div>
    <div style="display:flex;align-items:center;gap:14px;padding:16px 20px 14px;border-bottom:1px solid var(--border)">
      <div id="cd-avatar" style="width:48px;height:48px;border-radius:12px;background:var(--charcoal);color:var(--yellow);font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0">TE</div>
      <div style="flex:1;min-width:0">
        <div id="cd-name" style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--charcoal)">Client</div>
        <div id="cd-meta" style="font-size:12px;color:var(--lmuted);margin-top:2px"></div>
      </div>
      <div style="display:flex;gap:6px">
        <button id="cd-edit-btn" onclick="cdEdit()" style="background:var(--off);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:13px;font-weight:600;color:var(--charcoal);cursor:pointer">Edit</button>
        <button id="cd-delete-btn" onclick="cdDelete()" style="background:#FDF0EE;border:1px solid #F5D4CF;border-radius:8px;padding:8px 12px;font-size:13px;font-weight:600;color:#A84E2A;cursor:pointer">Delete</button>
        <button onclick="document.getElementById('client-detail-overlay').style.display='none'" style="background:var(--off);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:13px;font-weight:600;color:var(--muted);cursor:pointer">Close</button>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border);border-bottom:1px solid var(--border)">
      <div style="background:white;padding:14px 20px">
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--lmuted)">Total Billed</div>
        <div id="cd-total" style="font-family:'Barlow Condensed',sans-serif;font-size:26px;font-weight:900;color:var(--charcoal);margin-top:2px">$0</div>
      </div>
      <div style="background:white;padding:14px 20px">
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--lmuted)">Jobs</div>
        <div id="cd-jobcount" style="font-family:'Barlow Condensed',sans-serif;font-size:26px;font-weight:900;color:var(--charcoal);margin-top:2px">0</div>
      </div>
    </div>
    <div style="padding:14px 20px 6px">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;color:var(--charcoal);margin-bottom:4px">JOB HISTORY</div>
    </div>
    <div id="cd-jobs"></div>
    <div style="padding:14px 20px 6px;margin-top:4px">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;color:var(--charcoal);margin-bottom:4px">INVOICES</div>
    </div>
    <div id="cd-invoices"></div>
  </div>
</div>

<script>
const{createClient}=supabase;
const sb=createClient('https://qyrgkspwxjmbjnkaixag.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5cmdrc3B3eGptYmpua2FpeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NzQ0NTgsImV4cCI6MjA4NzU1MDQ1OH0.AHE_1iR8De17u-bVwsfzPc0nKK8MCDB5SEU5Ks531DA');

let clients=[],jobs=[],invoices=[];
let editingId={client:null,job:null,invoice:null};

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ
async function boot(){
  const{data:{session}}=await sb.auth.getSession();
  if(!session){window.location.href='/login.html';return;}
  const email=session.user.email;
  document.getElementById('user-email').textContent=email;
  document.getElementById('user-av').textContent=email.substring(0,2).toUpperCase();
  document.getElementById('today-date').textContent=new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric',year:'numeric'});
  await Promise.all([loadClients(),loadJobs(),loadInvoices(),loadFollowups(),loadServiceAlerts()]);
  renderClients();
  renderJobs();
  renderInvoices();
  renderDashboard();
  document.getElementById('loading-screen').style.display='none';
  document.getElementById('app').style.display='block';
}
boot();

async function signOut(){await sb.auth.signOut();window.location.href='/login.html';}

// ‚îÄ‚îÄ LOAD ‚îÄ‚îÄ
async function loadClients(){
  const{data}=await sb.from('clients').select('*').order('created_at',{ascending:false});
  clients=data||[];
  document.getElementById('nb-clients').textContent=clients.length;
}
async function loadJobs(){
  const{data}=await sb.from('jobs').select('*,clients(name)').order('date',{ascending:true});
  jobs=data||[];
  renderJobs();
}
async function loadFollowups(){
  const today=new Date(new Date().toDateString());
  const nextWeek=new Date(today.getTime()+7*86400000);
  const{data}=await sb.from('courts').select('id,name,location,status,followup_date,followup_status').not('followup_date','is',null).order('followup_date',{ascending:true});
  const due=(data||[]).filter(c=>{const d=new Date(c.followup_date);return d<=nextWeek;});
  const fuPanel=document.getElementById('followups-panel');
  const fuCount=document.getElementById('fu-count');
  if(due.length>0){
    fuPanel.style.display='block';
    fuCount.textContent=due.length+' due';
    document.getElementById('d-followups').innerHTML=due.map(c=>{
      const d=new Date(c.followup_date+'T00:00:00');
      const isOverdue=d<today;
      const isToday=d.toDateString()===today.toDateString();
      const dayLabel=isOverdue?'Overdue':isToday?'Today':d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
      const color=isOverdue?'#A84E2A':isToday?'#B88000':'#2A7A52';
      return`<div style="display:flex;align-items:center;padding:11px 16px;border-bottom:1px solid var(--border);gap:10px">
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:600;color:var(--charcoal)">${c.name}</div>
          <div style="font-size:11px;color:var(--lmuted);margin-top:1px">${c.location||'‚Äî'} ¬∑ ${c.followup_status||'Not contacted'}</div>
        </div>
        <div style="font-size:12px;font-weight:700;color:${color};white-space:nowrap">${dayLabel}</div>
      </div>`;
    }).join('');
  } else {
    fuPanel.style.display='none';
  }
}

async function loadServiceAlerts(){
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  const alerts = [];

  // 1. Clients with a next_visit date that is overdue or coming up within 60 days
  const cutoff = new Date(today.getTime() + 60*24*60*60*1000);
  clients.forEach(c=>{
    // Find their latest job with a next_visit
    const clientJobs = jobs.filter(j=>String(j.client_id)===String(c.id)||(j.clients&&j.clients.name===c.name));
    const withVisit = clientJobs.filter(j=>j.next_visit).sort((a,b)=>b.next_visit.localeCompare(a.next_visit));
    if(withVisit.length>0){
      const nv = new Date(withVisit[0].next_visit+'T00:00:00');
      const isOverdue = nv < today;
      const isSoon = nv <= cutoff;
      if(isOverdue){
        const days=Math.floor((today-nv)/(86400000));
        alerts.push({name:c.name,surface:c.surface,sub:days+' day'+(days!==1?'s':'')+' overdue',dot:'#A84E2A',color:'#A84E2A',urgency:3});
      } else if(isSoon){
        const days=Math.floor((nv-today)/(86400000));
        const label=days===0?'Today':days===1?'Tomorrow':'In '+days+' days';
        alerts.push({name:c.name,surface:c.surface,sub:'Next visit: '+label,dot:'#E8A800',color:'#B88000',urgency:2});
      }
    }
  });

  // 2. Clients with no jobs at all ‚Äî never been serviced
  clients.forEach(c=>{
    const clientJobs = jobs.filter(j=>String(j.client_id)===String(c.id)||(j.clients&&j.clients.name===c.name));
    if(clientJobs.length===0){
      alerts.push({name:c.name,surface:c.surface,sub:'No jobs recorded yet',dot:'#aaa',color:'#888',urgency:1});
    }
  });

  // 3. Also pull from prospect map courts with overdue last_service
  const{data:courts}=await sb.from('courts').select('name,surface,last_service,status').neq('status','client').order('name');
  (courts||[]).forEach(c=>{
    const ls=c.last_service||'';
    const yearMatch=ls.match(/\b(20\d{2}|19\d{2})\b/);
    const lastYear=yearMatch?parseInt(yearMatch[0]):null;
    const neverDone=!ls||ls.toLowerCase().includes('never');
    const yearsAgo=lastYear?today.getFullYear()-lastYear:null;
    if(neverDone){
      alerts.push({name:c.name,surface:c.surface,sub:'Never serviced ‚Äî prospect',dot:'#A84E2A',color:'#A84E2A',urgency:3});
    } else if(yearsAgo>=5){
      alerts.push({name:c.name,surface:c.surface,sub:yearsAgo+' yrs since last service',dot:'#A84E2A',color:'#A84E2A',urgency:3});
    } else if(yearsAgo>=3){
      alerts.push({name:c.name,surface:c.surface,sub:'Due this season',dot:'#E8A800',color:'#B88000',urgency:2});
    }
  });

  alerts.sort((a,b)=>b.urgency-a.urgency);

  const ac=document.getElementById('alerts-count');
  const urgent=alerts.filter(a=>a.urgency>=2);
  if(urgent.length>0){ac.textContent=urgent.length+' due';ac.style.display='inline';}
  else ac.style.display='none';

  document.getElementById('d-alerts').innerHTML=alerts.length===0
    ?'<div style="padding:20px 16px;font-size:13px;color:var(--lmuted);text-align:center">All clients up to date ‚úì</div>'
    :alerts.slice(0,8).map(a=>`
      <div style="display:flex;align-items:center;gap:10px;padding:11px 16px;border-bottom:1px solid var(--border)">
        <div style="width:9px;height:9px;border-radius:50%;background:${a.dot};flex-shrink:0"></div>
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:600;color:var(--charcoal)">${a.name}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:1px">${a.sub}</div>
        </div>
        ${a.surface?`<span style="font-size:10px;font-weight:700;color:${a.color};background:${a.color}18;padding:2px 7px;border-radius:5px;white-space:nowrap">${a.surface}</span>`:''}
      </div>`).join('');
}

async function loadInvoices(){
  const{data}=await sb.from('invoices').select('*,clients(name)').order('created_at',{ascending:false});
  invoices=data||[];
  document.getElementById('nb-invoices').textContent=invoices.filter(i=>i.status==='pending').length;
  renderInvoices();
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
function renderDashboard(){
  const now = new Date();
  const hour = now.getHours();
  const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
  document.getElementById('dash-greeting').textContent = greeting;
  document.getElementById('today-date').textContent = now.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});

  // Stats
  const thisMonth = now.getMonth();
  const thisYear = now.getFullYear();
  const totalCourts = clients.reduce((s,c)=>s+(c.courts||1),0);
  const ytdJobs = jobs.filter(j=>{if(!j.date)return false;return new Date(j.date).getFullYear()===thisYear;});
  const ytdRev = ytdJobs.reduce((s,j)=>s+(j.amount||0),0);
  const pend = invoices.filter(i=>i.status==='pending'||i.status==='overdue');
  const pendAmt = pend.reduce((s,i)=>s+(i.amount||0),0);
  const overdue = invoices.filter(i=>i.status==='overdue');
  const monthJobs = jobs.filter(j=>{if(!j.date)return false;const d=new Date(j.date);return d.getMonth()===thisMonth&&d.getFullYear()===thisYear;});
  const monthRev = monthJobs.reduce((s,j)=>s+(j.amount||0),0);

  document.getElementById('s-revenue').textContent='$'+ytdRev.toLocaleString();
  document.getElementById('s-revenue-sub').textContent=ytdJobs.length+' job'+(ytdJobs.length!==1?'s':'')+' this year';
  document.getElementById('s-clients').textContent=clients.length;
  document.getElementById('s-clients-sub').textContent=totalCourts+' court'+(totalCourts!==1?'s':'');
  document.getElementById('s-pending').textContent='$'+pendAmt.toLocaleString();
  document.getElementById('s-pending-sub').textContent=pend.length+' unpaid invoice'+(pend.length!==1?'s':'');
  document.getElementById('s-month').textContent=monthJobs.length;
  document.getElementById('s-month-sub').textContent='$'+monthRev.toLocaleString()+' revenue';

  // Overdue badge
  const od = document.getElementById('overdue-count');
  if(overdue.length>0){od.textContent=overdue.length+' overdue';od.style.display='inline';}
  else od.style.display='none';

  // Upcoming jobs (scheduled, future dates)
  const upcoming = jobs.filter(j=>j.status==='scheduled'||j.status==='Scheduled').sort((a,b)=>new Date(a.date||'9999')-new Date(b.date||'9999'));
  const uc = document.getElementById('upcoming-count');
  uc.textContent = upcoming.length > 0 ? upcoming.length : '';
  document.getElementById('d-upcoming').innerHTML = upcoming.length===0
    ? empty('No upcoming jobs ‚Äî tap "Add Job" to schedule one')
    : upcoming.slice(0,5).map(j=>{
        const d = new Date(j.date);
        const isToday = d.toDateString()===new Date().toDateString();
        const isTomorrow = d.toDateString()===new Date(Date.now()+86400000).toDateString();
        const dayLabel = isToday ? '<span style="color:#2A7A52;font-weight:700">Today</span>' : isTomorrow ? '<span style="color:#B88000;font-weight:700">Tomorrow</span>' : d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
        return `<div class="c-row" style="align-items:center">
          <div style="width:44px;text-align:center;flex-shrink:0">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;color:var(--charcoal);line-height:1">${d.getDate()}</div>
            <div style="font-size:9px;font-weight:700;text-transform:uppercase;color:var(--lmuted)">${d.toLocaleDateString('en-US',{month:'short'})}</div>
          </div>
          <div style="flex:1;min-width:0">
            <div class="c-name">${j.clients?.name||clients.find(c=>c.id==j.client_id)?.name||'?'}</div>
            <div class="c-meta">${j.service||'‚Äî'} ¬∑ ${dayLabel}</div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div style="font-size:13px;font-weight:700;color:var(--charcoal)">$${(j.amount||0).toLocaleString()}</div>
            <div style="font-size:10px;color:var(--lmuted)">${j.service||''}</div>
          </div>
        </div>`;
      }).join('');

  // Outstanding invoices
  document.getElementById('d-invoices').innerHTML = pend.length===0
    ? `<div class="empty" style="padding:24px"><p>üéâ All invoices paid!</p></div>`
    : pend.slice(0,5).map(i=>`<div class="c-row" style="align-items:center">
        <div style="flex:1;min-width:0">
          <div class="c-name">${i.clients?.name||'?'}</div>
          <div class="c-meta">${i.issued_date?new Date(i.issued_date).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'‚Äî'}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
          <div style="font-size:13px;font-weight:700;color:var(--charcoal)">$${(i.amount||0).toLocaleString()}</div>
          ${ibadge(i.status)}
          <button class="act-btn act-paid" style="padding:4px 10px;font-size:11px" onclick="markPaid('${i.id}')">‚úì Paid</button>
        </div>
      </div>`).join('');

  // Active clients
  document.getElementById('d-clients').innerHTML = clients.length===0
    ? empty('No clients yet')
    : clients.slice(0,5).map(c=>`<div class="c-row" style="cursor:pointer" onclick="showClientDetail('${c.id}')"><div class="c-av">${c.name.substring(0,2).toUpperCase()}</div><div style="flex:1;min-width:0"><div class="c-name">${c.name}</div><div class="c-meta">${c.courts||1} court${(c.courts||1)!==1?'s':''} ¬∑ ${c.location||'‚Äî'}</div></div><div style="font-size:13px;font-weight:700;color:var(--charcoal)">$${clientTotal(c).toLocaleString()}</div></div>`).join('');

  // Recently completed jobs
  const completed = jobs.filter(j=>j.status==='completed').slice(0,4);
  document.getElementById('d-completed').innerHTML = completed.length===0
    ? empty('No completed jobs yet')
    : completed.map(j=>`<div class="c-row" style="align-items:center">
        <div style="width:44px;text-align:center;flex-shrink:0">
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;color:var(--glight);line-height:1">${j.date?new Date(j.date).getDate():'‚Äî'}</div>
          <div style="font-size:9px;font-weight:700;text-transform:uppercase;color:var(--lmuted)">${j.date?new Date(j.date).toLocaleDateString('en-US',{month:'short'}):''}</div>
        </div>
        <div style="flex:1;min-width:0">
          <div class="c-name">${j.clients?.name||'?'}</div>
          <div class="c-meta">${j.service||'‚Äî'}</div>
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div style="font-size:13px;font-weight:700;color:var(--charcoal)">$${(j.amount||0).toLocaleString()}</div>
          ${jbadge(j.status)}
        </div>
      </div>`).join('');
}

// ‚îÄ‚îÄ CLIENTS TABLE ‚îÄ‚îÄ
function clientTotal(c){
  return jobs.filter(j=>String(j.client_id)===String(c.id)||(j.clients&&j.clients.name===c.name)).reduce((s,j)=>s+(j.amount||0),0);
}

function renderClients(){
  if(clients.length===0){document.getElementById('clients-list').innerHTML=empty('No clients yet ‚Äî tap "Add Client" to get started');return;}
  const tbl=`<table class="tbl desktop-table"><thead><tr><th>Client</th><th>Location</th><th>Surface</th><th>Courts</th><th>Billed</th><th></th></tr></thead><tbody>`+
    clients.map(c=>`<tr style="cursor:pointer" onclick="showClientDetail('${c.id}')">
      <td><div style="display:flex;align-items:center;gap:10px"><div class="c-av" style="width:30px;height:30px;font-size:11px;flex-shrink:0">${c.name.substring(0,2).toUpperCase()}</div><strong>${c.name}</strong></div></td>
      <td>${c.location||'‚Äî'}</td><td>${stag(c.surface)}</td><td>${c.courts||1}</td>
      <td><strong>$${clientTotal(c).toLocaleString()}</strong></td>
      <td><div class="row-actions" onclick="event.stopPropagation()"><button class="act-btn act-edit" onclick="editClient('${c.id}')">Edit</button><button class="act-btn act-delete" onclick="confirmDelete('client','${c.id}','${c.name.replace(/'/g,"\'")}')">Delete</button></div></td>
    </tr>`).join('')+`</tbody></table>`;
  const cards=clients.map(c=>`<div class="m-card" onclick="showClientDetail('${c.id}')" style="cursor:pointer">
    <div class="m-card-top"><div class="m-card-name">${c.name}</div><div class="m-card-amount">$${clientTotal(c).toLocaleString()}</div></div>
    <div class="m-card-meta">${c.location||'‚Äî'} ¬∑ ${c.courts||1} court${(c.courts||1)!==1?'s':''}</div>
    <div class="m-card-tags">${stag(c.surface)}</div>
    <div class="m-card-actions" onclick="event.stopPropagation()"><button class="act-btn act-edit" onclick="editClient('${c.id}')">Edit</button><button class="act-btn act-delete" onclick="confirmDelete('client','${c.id}','${c.name.replace(/'/g,"\'")}')">Delete</button></div>
  </div>`).join('');
  document.getElementById('clients-list').innerHTML=tbl+cards;
}

function showClientDetail(id){
  const c=clients.find(x=>String(x.id)===String(id));if(!c)return;
  const cJobs=jobs.filter(j=>String(j.client_id)===String(c.id)||(j.clients&&j.clients.name===c.name));
  const cInvoices=invoices.filter(i=>String(i.client_id)===String(c.id)||(i.clients&&i.clients.name===c.name));
  const total=cJobs.reduce((s,j)=>s+(j.amount||0),0);
  const fmt=d=>d?new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'‚Äî';
  const el=document.getElementById('client-detail-overlay');
  el.dataset.clientId=id;
  document.getElementById('cd-avatar').textContent=c.name.substring(0,2).toUpperCase();
  document.getElementById('cd-name').textContent=c.name;
  document.getElementById('cd-meta').textContent=(c.location||'')+(c.location&&c.surface?' ¬∑ ':'')+( c.surface||'')+(c.courts?' ¬∑ '+c.courts+' court'+(c.courts!==1?'s':''):'');
  document.getElementById('cd-total').textContent='$'+total.toLocaleString();
  document.getElementById('cd-jobcount').textContent=cJobs.length+' job'+(cJobs.length!==1?'s':'');
  document.getElementById('cd-jobs').innerHTML=cJobs.length===0
    ?'<div style="padding:20px;text-align:center;color:var(--lmuted);font-size:13px">No jobs yet</div>'
    :cJobs.sort((a,b)=>new Date(b.date||0)-new Date(a.date||0)).map(j=>`
      <div style="display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);gap:10px">
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:600;color:var(--charcoal)">${j.service||'‚Äî'}</div>
          <div style="font-size:11px;color:var(--lmuted);margin-top:2px">${fmt(j.date)}${j.notes?' ¬∑ '+j.notes:''}</div>
          ${j.next_visit?`<div style="font-size:10px;color:#2A7A52;margin-top:2px;font-weight:600">‚Ü© Next visit: ${fmt(j.next_visit)}</div>`:''}
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div style="font-size:13px;font-weight:700;color:var(--charcoal)">$${(j.amount||0).toLocaleString()}</div>
          ${jbadge(j.status)}
        </div>
      </div>`).join('');
  document.getElementById('cd-invoices').innerHTML=cInvoices.length===0
    ?'<div style="padding:16px;text-align:center;color:var(--lmuted);font-size:13px">No invoices</div>'
    :cInvoices.map(i=>`
      <div style="display:flex;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border);gap:10px">
        <div style="flex:1;font-size:13px;font-weight:600;color:var(--charcoal)">${fmt(i.issued_date||i.created_at)}</div>
        <div style="font-size:13px;font-weight:700;color:var(--charcoal)">$${(i.amount||0).toLocaleString()}</div>
        ${ibadge(i.status)}
      </div>`).join('');
  el.style.display='flex';
}

// ‚îÄ‚îÄ JOBS TABLE ‚îÄ‚îÄ
function renderJobs(){
  if(jobs.length===0){document.getElementById('jobs-list').innerHTML=empty('No jobs yet ‚Äî tap "Add Job" to schedule one');return;}
  const fmt=d=>d?new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'‚Äî';
  const tbl=`<table class="tbl desktop-table"><thead><tr><th>Client</th><th>Service</th><th>Date</th><th>Amount</th><th>Status</th><th></th></tr></thead><tbody>`+
    jobs.map(j=>`<tr>
      <td><strong>${j.clients?.name||'?'}</strong></td><td>${j.service||'‚Äî'}</td>
      <td>${fmt(j.date)}</td><td><strong>$${(j.amount||0).toLocaleString()}</strong></td>
      <td>${jbadge(j.status)}</td>
      <td><div class="row-actions"><button class="act-btn act-edit" onclick="editJob('${j.id}')">Edit</button><button class="act-btn act-delete" onclick="confirmDelete('job','${j.id}','${(j.service||'job').replace(/'/g,"\'")}')">Delete</button></div></td>
    </tr>`).join('')+`</tbody></table>`;
  const cards=jobs.map(j=>`<div class="m-card">
    <div class="m-card-top"><div class="m-card-name">${j.clients?.name||'?'}</div><div class="m-card-amount">$${(j.amount||0).toLocaleString()}</div></div>
    <div class="m-card-meta">${j.service||'‚Äî'} ¬∑ ${fmt(j.date)}</div>
    <div class="m-card-tags">${jbadge(j.status)}</div>
    <div class="m-card-actions"><button class="act-btn act-edit" onclick="editJob('${j.id}')">Edit</button><button class="act-btn act-delete" onclick="confirmDelete('job','${j.id}','${(j.service||'job').replace(/'/g,"\'")}')">Delete</button></div>
  </div>`).join('');
  document.getElementById('jobs-list').innerHTML=tbl+cards;
}

// ‚îÄ‚îÄ INVOICES TABLE ‚îÄ‚îÄ
function renderInvoices(){
  if(invoices.length===0){document.getElementById('invoices-list').innerHTML=empty('No invoices yet ‚Äî tap "New Invoice" to create one');return;}
  const fmt=d=>d?new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'‚Äî';
  const tbl=`<table class="tbl desktop-table"><thead><tr><th>Client</th><th>Amount</th><th>Date</th><th>Status</th><th></th></tr></thead><tbody>`+
    invoices.map(i=>`<tr>
      <td><strong>${i.clients?.name||'?'}</strong></td><td><strong>$${(i.amount||0).toLocaleString()}</strong></td>
      <td>${fmt(i.issued_date)}</td><td>${ibadge(i.status)}</td>
      <td><div class="row-actions">
        ${i.status!=='paid'?`<button class="act-btn act-paid" onclick="markPaid('${i.id}')">‚úì Paid</button>`:''}
        <button class="act-btn act-edit" onclick="editInvoice('${i.id}')">Edit</button>
        <button class="act-btn act-delete" onclick="confirmDelete('invoice','${i.id}','$${(i.amount||0).toLocaleString()} invoice')">Delete</button>
      </div></td>
    </tr>`).join('')+`</tbody></table>`;
  const cards=invoices.map(i=>`<div class="m-card">
    <div class="m-card-top"><div class="m-card-name">${i.clients?.name||'?'}</div><div class="m-card-amount">$${(i.amount||0).toLocaleString()}</div></div>
    <div class="m-card-meta">${fmt(i.issued_date)}</div>
    <div class="m-card-tags">${ibadge(i.status)}</div>
    <div class="m-card-actions">
      ${i.status!=='paid'?`<button class="act-btn act-paid" onclick="markPaid('${i.id}')">‚úì Paid</button>`:''}
      <button class="act-btn act-edit" onclick="editInvoice('${i.id}')">Edit</button>
      <button class="act-btn act-delete" onclick="confirmDelete('invoice','${i.id}','$${(i.amount||0).toLocaleString()} invoice')">Delete</button>
    </div>
  </div>`).join('');
  document.getElementById('invoices-list').innerHTML=tbl+cards;
}

// ‚îÄ‚îÄ MARK AS PAID ‚îÄ‚îÄ
async function markPaid(id){
  const{error}=await sb.from('invoices').update({status:'paid'}).eq('id',id);
  if(error){toast('Error: '+error.message,'err');return;}
  toast('Invoice marked as paid! üí∞','ok');
  await loadInvoices();renderDashboard();
}

// ‚îÄ‚îÄ EDIT CLIENT ‚îÄ‚îÄ
function editClient(id){
  const c=clients.find(x=>x.id===id);if(!c)return;
  editingId.client=id;
  document.getElementById('client-modal-title').textContent='Edit Client';
  document.getElementById('qa-steps').style.display='none';
  document.getElementById('edit-client-btns').style.display='flex';
  document.getElementById('qa-new-btns').style.display='none';
  document.getElementById('qa-page-1').style.display='block';
  document.getElementById('qa-page-2').style.display='none';
  document.getElementById('qa-page-3').style.display='none';
  document.getElementById('c-name').value=c.name||'';
  document.getElementById('c-loc').value=c.location||'';
  document.getElementById('c-surface').value=c.surface||'';
  document.getElementById('c-courts').value=c.courts||1;
  document.getElementById('c-notes').value=c.notes||'';
  document.getElementById('save-client-btn').textContent='Save Changes';
  document.getElementById('m-client').classList.add('open');
}

// ‚îÄ‚îÄ EDIT JOB ‚îÄ‚îÄ
function editJob(id){
  const j=jobs.find(x=>x.id===id);if(!j)return;
  editingId.job=id;
  document.getElementById('job-modal-title').textContent='Edit Job';
  document.getElementById('job-modal-sub').textContent='Changes save immediately';document.getElementById('job-modal-sub').style.display='block';
  const sel=document.getElementById('j-client');
  sel.innerHTML='<option value="">Select client</option>'+clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  sel.value=j.client_id||'';
  document.getElementById('j-service').value=j.service||'';
  document.getElementById('j-date').value=j.date||'';
  document.getElementById('j-amount').value=j.amount||'';
  document.getElementById('j-status').value=j.status||'scheduled';
  document.getElementById('j-notes').value=j.notes||'';
  document.getElementById('j-next-visit').value=j.next_visit||'';
  document.getElementById('save-job-btn').textContent='Save Changes';
  document.getElementById('m-job').classList.add('open');
}

// ‚îÄ‚îÄ EDIT INVOICE ‚îÄ‚îÄ
function editInvoice(id){
  const i=invoices.find(x=>x.id===id);if(!i)return;
  editingId.invoice=id;
  document.getElementById('invoice-modal-title').textContent='Edit Invoice';
  document.getElementById('invoice-modal-sub').textContent='Changes save immediately';document.getElementById('invoice-modal-sub').style.display='block';
  const sel=document.getElementById('i-client');
  sel.innerHTML='<option value="">Select client</option>'+clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  sel.value=i.client_id||'';
  document.getElementById('i-amount').value=i.amount||'';
  document.getElementById('i-status').value=i.status||'pending';
  document.getElementById('save-invoice-btn').textContent='Save Changes';
  document.getElementById('m-invoice').classList.add('open');
}

// ‚îÄ‚îÄ QUICK ADD STATE ‚îÄ‚îÄ
let qaMode=false, qaClientId=null;

function openModal(type){
  editingId[type]=null;
  if(type==='client'){
    qaClientId=null;
    document.getElementById('client-modal-title').textContent='Add Client';
    document.getElementById('qa-steps').style.display='none';
    document.getElementById('edit-client-btns').style.display='none';
    document.getElementById('qa-new-btns').style.display='block';
    document.getElementById('qa-page-1').style.display='block';
    document.getElementById('qa-page-2').style.display='none';
    document.getElementById('qa-page-3').style.display='none';
    ['c-name','c-loc','c-courts','c-notes','j-service','j-amount','i-amount'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
    document.getElementById('c-surface').value='';
    document.getElementById('c-status').value='active';
    document.getElementById('j-status').value='scheduled';
    document.getElementById('i-status').value='pending';
    document.getElementById('j-date').value=new Date().toISOString().split('T')[0];
  }
  if(type==='job'){
    document.getElementById('job-modal-title').textContent='Add Job';
    document.getElementById('job-modal-sub').textContent='';document.getElementById('job-modal-sub').style.display='none';
    document.getElementById('save-job-btn').textContent='Save Job';
    ['j-service','j-amount','j-notes','j-next-visit'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('j-status').value='scheduled';
    document.getElementById('j-date').value=new Date().toISOString().split('T')[0];
    const el=document.getElementById('j-client');
    el.innerHTML='<option value="">Select client</option>'+clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  }
  if(type==='invoice'){
    document.getElementById('invoice-modal-title').textContent='New Invoice';
    document.getElementById('invoice-modal-sub').textContent='';document.getElementById('invoice-modal-sub').style.display='none';
    document.getElementById('save-invoice-btn').textContent='Save Invoice';
    const el=document.getElementById('i-client');
    el.innerHTML='<option value="">Select client</option>'+clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  }
  document.getElementById('m-'+type).classList.add('open');
}

function qaNext(page){
  document.getElementById('qa-page-1').style.display='none';
  document.getElementById('qa-page-2').style.display='none';
  document.getElementById('qa-page-3').style.display='none';
  document.getElementById('qa-page-'+page).style.display='block';
  if(page===3){
    const jobAmt=parseFloat(document.getElementById('qa-j-amount').value)||0;
    document.getElementById('i-amount').value=jobAmt||'';
    document.getElementById('qa-inv-preview').textContent='$'+jobAmt.toLocaleString();
  }
  // Update step indicators
  [1,2,3].forEach(n=>{
    const el=document.getElementById('step-'+n);
    if(n<page){el.style.borderBottomColor='var(--glight)';el.style.color='var(--green)';}
    else if(n===page){el.style.borderBottomColor='var(--charcoal)';el.style.color='var(--charcoal)';}
    else{el.style.borderBottomColor='var(--border)';el.style.color='var(--lmuted)';}
  });
}

async function saveClientOnly(){
  // Save client and close without adding job/invoice
  const name=document.getElementById('c-name').value.trim();
  if(!name){toast('Enter a client name','err');return;}
  const payload={name,location:document.getElementById('c-loc').value.trim(),surface:document.getElementById('c-surface').value,courts:parseInt(document.getElementById('c-courts').value)||1,notes:document.getElementById('c-notes').value.trim()};
  const{error}=await sb.from('clients').insert(payload);
  if(error){toast('Error: '+error.message,'err');return;}
  closeModal('client');
  toast('Client saved!','ok');
  await loadClients();renderDashboard();
}

async function qaFinish(saveJob, saveInvoice){
  const btn=document.getElementById('qa-finish-btn')||document.getElementById('save-client-btn');
  if(btn){btn.disabled=true;btn.textContent='Saving...';}

  // Save job if requested
  if(saveJob && qaClientId){
    const svc=document.getElementById('qa-j-service').value.trim();
    if(svc){
      await sb.from('jobs').insert({
        client_id:qaClientId,
        service:svc,
        date:document.getElementById('qa-j-date').value||null,
        amount:parseFloat(document.getElementById('qa-j-amount').value)||0,
        status:document.getElementById('qa-j-status').value
      });
    }
  }

  // Save invoice if requested
  if(saveInvoice && qaClientId){
    const amt=parseFloat(document.getElementById('i-amount').value);
    if(amt){
      await sb.from('invoices').insert({
        client_id:qaClientId,
        amount:amt,
        status:document.getElementById('i-status').value
      });
    }
  }

  if(btn){btn.disabled=false;}
  closeModal('client');
  toast('All saved! üéâ','ok');
  await Promise.all([loadClients(),loadJobs(),loadInvoices()]);
  renderClients();renderJobs();renderInvoices();renderDashboard();
}

// ‚îÄ‚îÄ SAVE CLIENT (add or edit) ‚îÄ‚îÄ
async function saveClient(){
  const name=document.getElementById('c-name').value.trim();
  if(!name){toast('Enter a client name','err');return;}
  const btn=document.getElementById('save-client-btn');
  if(btn){btn.disabled=true;btn.textContent='Saving...';}
  const payload={name,location:document.getElementById('c-loc').value.trim(),surface:document.getElementById('c-surface').value,courts:parseInt(document.getElementById('c-courts').value)||1,notes:document.getElementById('c-notes').value.trim()};
  let error,data;
  if(editingId.client){
    ({error}=await sb.from('clients').update(payload).eq('id',editingId.client));
  } else {
    ({data,error}=await sb.from('clients').insert(payload).select().single());
  }
  if(btn){btn.disabled=false;btn.textContent=editingId.client?'Save Changes':'Save Client';}
  if(error){toast('Error: '+error.message,'err');return;}

  // If in quick-add mode (new client), go to job step
  if(!editingId.client && data){
    qaClientId=data.id;
    document.getElementById('qa-client-name-display').textContent=name;
    document.getElementById('qa-client-name-display2').textContent=name;
    document.getElementById('qa-steps').style.display='block';
    document.getElementById('qa-new-btns').style.display='none';
    qaNext(2);
    return;
  }

  closeModal('client');
  toast(editingId.client?'Client updated!':'Client saved!','ok');
  await loadClients();renderDashboard();
}


// ‚îÄ‚îÄ SAVE JOB (add or edit) ‚îÄ‚îÄ
async function saveJob(){
  const cid=document.getElementById('j-client').value;
  const svc=document.getElementById('j-service').value.trim();
  if(!cid||!svc){toast('Please fill in all fields','err');return;}
  const btn=document.getElementById('save-job-btn');
  btn.disabled=true;btn.textContent='Saving...';
  const payload={client_id:cid,service:svc,date:document.getElementById('j-date').value||null,amount:parseFloat(document.getElementById('j-amount').value)||0,status:document.getElementById('j-status').value,notes:document.getElementById('j-notes').value.trim()||null,next_visit:document.getElementById('j-next-visit').value||null};
  let error;
  if(editingId.job){
    ({error}=await sb.from('jobs').update(payload).eq('id',editingId.job));
  } else {
    ({error}=await sb.from('jobs').insert(payload));
  }
  btn.disabled=false;btn.textContent=editingId.job?'Save Changes':'Save Job';
  if(error){toast('Error: '+error.message,'err');return;}
  closeModal('job');
  toast(editingId.job?'Job updated!':'Job saved!','ok');
  await loadJobs();renderClients();renderDashboard();
}

// ‚îÄ‚îÄ SAVE INVOICE (add or edit) ‚îÄ‚îÄ
async function saveInvoice(){
  const cid=document.getElementById('i-client').value;
  const amt=parseFloat(document.getElementById('i-amount').value);
  if(!cid||!amt){toast('Please fill in all fields','err');return;}
  const btn=document.getElementById('save-invoice-btn');
  btn.disabled=true;btn.textContent='Saving...';
  const payload={client_id:cid,amount:amt,status:document.getElementById('i-status').value};
  let error;
  if(editingId.invoice){
    ({error}=await sb.from('invoices').update(payload).eq('id',editingId.invoice));
  } else {
    ({error}=await sb.from('invoices').insert(payload));
  }
  btn.disabled=false;btn.textContent=editingId.invoice?'Save Changes':'Save Invoice';
  if(error){toast('Error: '+error.message,'err');return;}
  closeModal('invoice');
  toast(editingId.invoice?'Invoice updated!':'Invoice created!','ok');
  await loadInvoices();renderDashboard();
}

// ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ
let pendingDelete={type:null,id:null};
function confirmDelete(type,id,label){
  pendingDelete={type,id};
  const extra=type==='client'?' All jobs and invoices for this client will also be deleted.':'';
  document.getElementById('confirm-msg').textContent=`Delete "${label}"? This cannot be undone.${extra}`;
  const co=document.getElementById('confirm-overlay');co.style.display='flex';
  document.getElementById('confirm-ok-btn').onclick=doDelete;
}
function closeConfirm(){document.getElementById('confirm-overlay').style.display='none';pendingDelete={type:null,id:null};}
async function doDelete(){
  const{type,id}=pendingDelete;
  closeConfirm();
  // Optimistically remove from local state immediately
  if(type==='client'){
    clients=clients.filter(x=>x.id!=id);
    jobs=jobs.filter(x=>x.client_id!=id);
    invoices=invoices.filter(x=>x.client_id!=id);
    document.getElementById('nb-clients').textContent=clients.length;
  } else if(type==='job'){
    jobs=jobs.filter(x=>x.id!=id);
  } else {
    invoices=invoices.filter(x=>x.id!=id);
    document.getElementById('nb-invoices').textContent=invoices.filter(i=>i.status==='pending').length;
  }
  renderClients();renderJobs();renderInvoices();renderDashboard();
  toast('Deleted','ok');
  // Now delete from database in background
  if(type==='client'){
    await sb.from('jobs').delete().eq('client_id',id);
    await sb.from('invoices').delete().eq('client_id',id);
    await sb.from('clients').delete().eq('id',id);
  } else if(type==='job'){
    await sb.from('jobs').delete().eq('id',id);
  } else {
    await sb.from('invoices').delete().eq('id',id);
  }
}

// ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ
function closeModal(type){document.getElementById('m-'+type).classList.remove('open');editingId[type]=null;}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o&&o.id!=='confirm-overlay'){const t=o.id.replace('m-','');closeModal(t);}}));

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function nav(name,el){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  if(el)el.classList.add('active');
  else document.querySelector(`.nav-item[onclick*="'${name}'"]`)?.classList.add('active');
  closeSidebar();window.scrollTo(0,0);
}
function openSidebar(){document.getElementById('sidebar').classList.add('open');document.getElementById('sidebar-overlay').classList.add('open');}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebar-overlay').classList.remove('open');}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function stag(s){const m={'Har-Tru':'tag-hartru','Hard':'tag-hard','Hard Court':'tag-hard','Red Clay':'tag-clay'};return`<span class="tag ${m[s]||'tag-def'}">${s||'‚Äî'}</span>`;}
function jbadge(s){const m={scheduled:'b-scheduled',completed:'b-completed',cancelled:'b-cancelled'};return`<span class="badge ${m[s]||'b-scheduled'}">${s||'scheduled'}</span>`;}
function ibadge(s){const m={paid:'b-paid',pending:'b-pending',overdue:'b-overdue'};return`<span class="badge ${m[s]||'b-pending'}">${s||'pending'}</span>`;}
function empty(msg){return`<div class="empty"><p>${msg}</p></div>`;}
function cdEdit(){
  const id=document.getElementById('client-detail-overlay').dataset.clientId;
  document.getElementById('client-detail-overlay').style.display='none';
  editClient(id);
}
function cdDelete(){
  const id=document.getElementById('client-detail-overlay').dataset.clientId;
  const c=clients.find(x=>String(x.id)===String(id));
  if(!c)return;
  document.getElementById('client-detail-overlay').style.display='none';
  confirmDelete('client',id,c.name);
}
function toast(msg,type='ok'){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show'+(type==='ok'?' ok':'');setTimeout(()=>t.className='toast',3000);}
</script>

</body>
</html>