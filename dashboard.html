<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resurfr — Contractor Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --yellow: #C8E62B;
  --yellow-dim: rgba(200,230,43,0.12);
  --green: #1E4D35;
  --green-light: #4CAF80;
  --white: #FFFFFF;
  --off: #F4F6F1;
  --border: #E2E8DC;
  --charcoal: #181C17;
  --text: #1A1F18;
  --muted: #6B7A65;
  --light-muted: #9DAA96;
  --sidebar-w: 220px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:'DM Sans',sans-serif;background:var(--off);color:var(--text);display:flex}
.sidebar{width:var(--sidebar-w);min-width:var(--sidebar-w);background:var(--charcoal);height:100vh;display:flex;flex-direction:column;position:fixed;left:0;top:0;z-index:50}
.sidebar-logo{padding:20px 20px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:8px}
.logo-badge{background:var(--yellow);border-radius:8px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.logo-text{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;color:white}
.nav-section-label{font-size:9px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:rgba(255,255,255,0.2);padding:12px 20px 6px}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 20px;margin:1px 8px;border-radius:8px;font-size:13px;font-weight:500;color:rgba(255,255,255,0.45);cursor:pointer;transition:all .2s;text-decoration:none}
.nav-item svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0}
.nav-item:hover{background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.8)}
.nav-item.active{background:var(--yellow-dim);color:var(--yellow);border:1px solid rgba(200,230,43,0.2)}
.nav-item.active svg{stroke:var(--yellow)}
.sidebar-bottom{margin-top:auto;padding:16px;border-top:1px solid rgba(255,255,255,0.06)}
.user-card{display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(255,255,255,0.05);border-radius:10px}
.user-avatar{width:32px;height:32px;border-radius:8px;background:var(--green);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;color:white;flex-shrink:0}
.user-name{font-size:12px;font-weight:600;color:rgba(255,255,255,0.8)}
.user-plan{font-size:10px;color:rgba(255,255,255,0.3)}
.nav-badge{margin-left:auto;background:var(--yellow);color:var(--charcoal);font-size:9px;font-weight:800;border-radius:10px;padding:1px 6px}
.main{margin-left:var(--sidebar-w);flex:1;height:100vh;overflow-y:auto;display:flex;flex-direction:column}
.topbar{background:white;border-bottom:1px solid var(--border);padding:0 28px;height:56px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:40;flex-shrink:0}
.topbar-title{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--charcoal)}
.topbar-right{display:flex;align-items:center;gap:12px}
.topbar-date{font-size:12px;color:var(--light-muted);font-weight:500}
.btn-sm{padding:7px 16px;border-radius:7px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .2s;display:flex;align-items:center;gap:6px}
.btn-sm svg{width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.btn-primary{background:var(--charcoal);color:white}
.btn-primary:hover{background:var(--green)}
.btn-yellow{background:var(--yellow);color:var(--charcoal)}
.btn-yellow:hover{background:#d4f030}
.btn-ghost{background:var(--off);color:var(--muted);border:1px solid var(--border)}
.content{padding:24px 28px;flex:1}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:22px}
.stat-card{background:white;border:1px solid var(--border);border-radius:12px;padding:20px 22px;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.stat-card.revenue::before{background:var(--yellow)}
.stat-card.clients::before{background:var(--green-light)}
.stat-card.pending::before{background:#F0B429}
.stat-card.jobs::before{background:var(--green)}
.stat-label{font-size:11px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--light-muted);margin-bottom:8px}
.stat-value{font-family:'Barlow Condensed',sans-serif;font-size:34px;font-weight:900;color:var(--charcoal);line-height:1;margin-bottom:6px}
.stat-sub{font-size:11px;color:var(--light-muted)}
.panel{background:white;border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:16px}
.panel-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.panel-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;color:var(--charcoal)}
.panel-action{font-size:11px;font-weight:600;color:var(--green);cursor:pointer;border:none;background:none;font-family:'DM Sans',sans-serif}
.view{display:none}
.view.active{display:block}
.prospect-table{width:100%;border-collapse:collapse}
.prospect-table th{padding:10px 20px;text-align:left;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--light-muted);background:var(--off);border-bottom:1px solid var(--border)}
.prospect-table td{padding:12px 20px;border-bottom:1px solid var(--border);font-size:13px;color:var(--text);vertical-align:middle}
.prospect-table tr:hover td{background:#FAFFF8}
.prospect-table tr:last-child td{border-bottom:none}
.surface-tag{padding:3px 9px;border-radius:4px;font-size:10px;font-weight:700;letter-spacing:0.5px}
.tag-hard{background:#FDF3E0;color:#B8842A}
.tag-hartru{background:#E8F5EE;color:#2A7A52}
.tag-clay{background:#FDEEE8;color:#A84E2A}
.tag-default{background:var(--off);color:var(--muted)}
.status-badge{padding:3px 10px;border-radius:4px;font-size:10px;font-weight:700;display:inline-block}
.badge-active{background:#E8F5EE;color:#2A7A52}
.invoice-status{padding:3px 10px;border-radius:4px;font-size:10px;font-weight:700}
.inv-paid{background:#E8F5EE;color:#2A7A52}
.inv-pending{background:#FFF8E6;color:#B88000}
.inv-overdue{background:#FDEEE8;color:#A84E2A}
.empty-state{padding:48px 20px;text-align:center;color:var(--light-muted)}
.empty-state svg{width:40px;height:40px;stroke:var(--border);fill:none;stroke-width:1.5;margin-bottom:12px}
.empty-state p{font-size:14px;margin-bottom:16px}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:200;display:none;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:white;border-radius:16px;padding:32px;width:100%;max-width:480px;box-shadow:0 20px 60px rgba(0,0,0,0.2)}
.modal-title{font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:800;color:var(--charcoal);margin-bottom:20px}
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:11px;font-weight:700;letter-spacing:0.5px;color:var(--muted);margin-bottom:5px;text-transform:uppercase}
.form-input{width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--charcoal);outline:none;transition:border-color .2s;background:var(--off)}
.form-input:focus{border-color:var(--green);background:white}
.modal-actions{display:flex;gap:10px;margin-top:20px}
.modal-actions button{flex:1;padding:12px;border-radius:7px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.btn-cancel{background:var(--off);color:var(--muted);border:1px solid var(--border)}
.btn-save{background:var(--charcoal);color:white}
.btn-save:hover{background:var(--green)}
.loading{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--light-muted);font-size:13px;gap:8px}
.spinner{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin .6s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{position:fixed;bottom:24px;right:24px;background:var(--charcoal);color:white;padding:12px 20px;border-radius:8px;font-size:13px;font-weight:500;z-index:300;transform:translateY(80px);opacity:0;transition:all .3s}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{background:var(--green)}
.main::-webkit-scrollbar{width:4px}
.main::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.client-row{display:flex;align-items:center;padding:12px 20px;border-bottom:1px solid var(--border);gap:12px;cursor:pointer;transition:background .15s}
.client-row:last-child{border-bottom:none}
.client-row:hover{background:var(--off)}
.client-avatar{width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;flex-shrink:0;background:#E8F2EC;color:var(--green)}
.client-info{flex:1;min-width:0}
.client-name{font-size:13px;font-weight:600;color:var(--charcoal);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.client-meta{font-size:11px;color:var(--light-muted);margin-top:1px}
</style>
</head>
<body>

<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-badge">
      <svg width="20" height="20" viewBox="0 0 40 40" fill="none">
        <rect x="2" y="5" width="36" height="30" rx="3.5" fill="rgba(26,31,24,0.08)" stroke="#1A1F18" stroke-width="2.2"/>
        <line x1="2" y1="20" x2="38" y2="20" stroke="#1A1F18" stroke-width="2.5"/>
        <line x1="20" y1="5" x2="20" y2="35" stroke="#1A1F18" stroke-width="1.5"/>
        <line x1="10" y1="5" x2="10" y2="20" stroke="#1A1F18" stroke-width="1.2"/>
        <line x1="30" y1="5" x2="30" y2="20" stroke="#1A1F18" stroke-width="1.2"/>
        <path d="M2 27 Q11 22 20 27 Q29 32 38 27" stroke="#1A1F18" stroke-width="2.5" stroke-linecap="round" fill="none"/>
      </svg>
    </div>
    <span class="logo-text">Resurfr</span>
  </div>
  <div class="nav-section-label">Main</div>
  <a class="nav-item active" onclick="showView('dashboard',this)">
    <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
    Dashboard
  </a>
  <a class="nav-item" onclick="showView('clients',this)">
    <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    Clients <span class="nav-badge" id="clients-badge">0</span>
  </a>
  <a class="nav-item" onclick="showView('jobs',this)">
    <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    Jobs
  </a>
  <div class="nav-section-label" style="margin-top:8px">Finance</div>
  <a class="nav-item" onclick="showView('invoices',this)">
    <svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
    Invoices <span class="nav-badge" id="invoices-badge">0</span>
  </a>
  <div class="sidebar-bottom">
    <div class="user-card">
      <div class="user-avatar">MR</div>
      <div>
        <div class="user-name">Mike Richardson</div>
        <div class="user-plan">Pro Plan</div>
      </div>
    </div>
  </div>
</aside>

<div class="main" id="main-content">

  <div id="view-dashboard" class="view active">
    <div class="topbar">
      <div class="topbar-title">Dashboard</div>
      <div class="topbar-right">
        <span class="topbar-date" id="today-date"></span>
        <button class="btn-sm btn-yellow" onclick="openModal('client')">
          <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Client
        </button>
      </div>
    </div>
    <div class="content">
      <div class="stats-row">
        <div class="stat-card revenue"><div class="stat-label">Total Billed</div><div class="stat-value" id="stat-revenue">$0</div><div class="stat-sub">All time</div></div>
        <div class="stat-card clients"><div class="stat-label">Active Clients</div><div class="stat-value" id="stat-clients">0</div><div class="stat-sub">In your database</div></div>
        <div class="stat-card pending"><div class="stat-label">Pending Invoices</div><div class="stat-value" id="stat-pending">$0</div><div class="stat-sub" id="stat-pending-count">0 unpaid</div></div>
        <div class="stat-card jobs"><div class="stat-label">Total Jobs</div><div class="stat-value" id="stat-jobs">0</div><div class="stat-sub">Scheduled & completed</div></div>
      </div>
      <div class="two-col">
        <div class="panel">
          <div class="panel-header"><div class="panel-title">Recent Clients</div><button class="panel-action" onclick="showView('clients',null)">View all</button></div>
          <div id="dashboard-clients"><div class="loading"><div class="spinner"></div> Loading...</div></div>
        </div>
        <div class="panel">
          <div class="panel-header"><div class="panel-title">Recent Jobs</div><button class="panel-action" onclick="showView('jobs',null)">View all</button></div>
          <div id="dashboard-jobs"><div class="loading"><div class="spinner"></div> Loading...</div></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Recent Invoices</div><button class="panel-action" onclick="showView('invoices',null)">View all</button></div>
        <div id="dashboard-invoices"><div class="loading"><div class="spinner"></div> Loading...</div></div>
      </div>
    </div>
  </div>

  <div id="view-clients" class="view">
    <div class="topbar">
      <div class="topbar-title">Clients</div>
      <div class="topbar-right">
        <button class="btn-sm btn-yellow" onclick="openModal('client')">
          <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Client
        </button>
      </div>
    </div>
    <div style="padding:20px 28px">
      <div class="panel"><div id="clients-list"><div class="loading"><div class="spinner"></div> Loading...</div></div></div>
    </div>
  </div>

  <div id="view-jobs" class="view">
    <div class="topbar">
      <div class="topbar-title">Jobs</div>
      <div class="topbar-right">
        <button class="btn-sm btn-yellow" onclick="openModal('job')">
          <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Job
        </button>
      </div>
    </div>
    <div style="padding:20px 28px">
      <div class="panel"><div id="jobs-list"><div class="loading"><div class="spinner"></div> Loading...</div></div></div>
    </div>
  </div>

  <div id="view-invoices" class="view">
    <div class="topbar">
      <div class="topbar-title">Invoices</div>
      <div class="topbar-right">
        <button class="btn-sm btn-yellow" onclick="openModal('invoice')">
          <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          New Invoice
        </button>
      </div>
    </div>
    <div style="padding:20px 28px">
      <div class="panel"><div id="invoices-list"><div class="loading"><div class="spinner"></div> Loading...</div></div></div>
    </div>
  </div>

</div>

<!-- MODALS -->
<div class="modal-overlay" id="modal-client">
  <div class="modal">
    <div class="modal-title">Add New Client</div>
    <div class="form-group"><label class="form-label">Client / Facility Name</label><input type="text" class="form-input" id="client-name" placeholder="Westport Tennis Club"></div>
    <div class="form-group"><label class="form-label">Location</label><input type="text" class="form-input" id="client-location" placeholder="Westport, CT"></div>
    <div class="form-group"><label class="form-label">Surface Type</label>
      <select class="form-input" id="client-surface">
        <option value="">Select surface</option>
        <option value="Har-Tru">Har-Tru</option>
        <option value="Hard">Hard Court (Asphalt/Concrete)</option>
        <option value="Red Clay">Red Clay</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">Number of Courts</label><input type="number" class="form-input" id="client-courts" placeholder="4" min="1"></div>
    <div class="form-group"><label class="form-label">Notes</label><input type="text" class="form-input" id="client-notes" placeholder="Any notes..."></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('client')">Cancel</button>
      <button class="btn-save" onclick="saveClient()">Save Client</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-job">
  <div class="modal">
    <div class="modal-title">Add New Job</div>
    <div class="form-group"><label class="form-label">Client</label><select class="form-input" id="job-client"></select></div>
    <div class="form-group"><label class="form-label">Service</label><input type="text" class="form-input" id="job-service" placeholder="Har-Tru topdressing"></div>
    <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="job-date"></div>
    <div class="form-group"><label class="form-label">Amount ($)</label><input type="number" class="form-input" id="job-amount" placeholder="3800"></div>
    <div class="form-group"><label class="form-label">Status</label>
      <select class="form-input" id="job-status">
        <option value="scheduled">Scheduled</option>
        <option value="completed">Completed</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('job')">Cancel</button>
      <button class="btn-save" onclick="saveJob()">Save Job</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-invoice">
  <div class="modal">
    <div class="modal-title">New Invoice</div>
    <div class="form-group"><label class="form-label">Client</label><select class="form-input" id="invoice-client"></select></div>
    <div class="form-group"><label class="form-label">Amount ($)</label><input type="number" class="form-input" id="invoice-amount" placeholder="3800"></div>
    <div class="form-group"><label class="form-label">Status</label>
      <select class="form-input" id="invoice-status">
        <option value="pending">Pending</option>
        <option value="paid">Paid</option>
        <option value="overdue">Overdue</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('invoice')">Cancel</button>
      <button class="btn-save" onclick="saveInvoice()">Save Invoice</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const { createClient } = supabase;
const sb = createClient(
  'https://qyrgkspwxjmbjnkaixag.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5cmdrc3B3eGptYmpua2FpeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NzQ0NTgsImV4cCI6MjA4NzU1MDQ1OH0.AHE_1iR8De17u-bVwsfzPc0nKK8MCDB5SEU5Ks531DA'
);

// Auth check — redirect to login if not signed in
sb.auth.getSession().then(({ data: { session } }) => {
  if (!session) window.location.href = '/login.html';
});
const sb = createClient(
  'https://qyrgkspwxjmbjnkaixag.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5cmdrc3B3eGptYmpua2FpeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NzQ0NTgsImV4cCI6MjA4NzU1MDQ1OH0.AHE_1iR8De17u-bVwsfzPc0nKK8MCDB5SEU5Ks531DA'
);

let clients = [], jobs = [], invoices = [];

  // Auth check — redirect to login if not signed in
sb.auth.getSession().then(({ data: { session } }) => {
  if (!session) window.location.href = '/login.html';
});
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('today-date').textContent = new Date().toLocaleDateString('en-US', {weekday:'long',month:'short',day:'numeric',year:'numeric'});
  loadAll();
});

async function loadAll() {
  await Promise.all([loadClients(), loadJobs(), loadInvoices()]);
  renderDashboard();
}

async function loadClients() {
  const { data } = await sb.from('clients').select('*').order('created_at', {ascending:false});
  clients = data || [];
  document.getElementById('clients-badge').textContent = clients.length;
  renderClients();
}

async function loadJobs() {
  const { data } = await sb.from('jobs').select('*, clients(name)').order('date', {ascending:false});
  jobs = data || [];
  renderJobs();
}

async function loadInvoices() {
  const { data } = await sb.from('invoices').select('*, clients(name)').order('created_at', {ascending:false});
  invoices = data || [];
  const pending = invoices.filter(i => i.status === 'pending');
  document.getElementById('invoices-badge').textContent = pending.length;
  renderInvoices();
}

function renderDashboard() {
  const totalBilled = clients.reduce((s,c) => s + (c.total_billed||0), 0);
  const pendingTotal = invoices.filter(i=>i.status==='pending').reduce((s,i) => s+(i.amount||0), 0);
  const pendingCount = invoices.filter(i=>i.status==='pending').length;
  document.getElementById('stat-revenue').textContent = '$'+totalBilled.toLocaleString();
  document.getElementById('stat-clients').textContent = clients.length;
  document.getElementById('stat-pending').textContent = '$'+pendingTotal.toLocaleString();
  document.getElementById('stat-pending-count').textContent = pendingCount+' unpaid';
  document.getElementById('stat-jobs').textContent = jobs.length;

  const dc = document.getElementById('dashboard-clients');
  dc.innerHTML = clients.length === 0 ? emptyState('No clients yet','Add your first client to get started') :
    clients.slice(0,4).map(c=>`
      <div class="client-row">
        <div class="client-avatar">${c.name.substring(0,2).toUpperCase()}</div>
        <div class="client-info"><div class="client-name">${c.name}</div><div class="client-meta">${c.courts||1} courts · ${c.location||'No location'}</div></div>
        ${surfaceTag(c.surface)}
      </div>`).join('');

  const dj = document.getElementById('dashboard-jobs');
  dj.innerHTML = jobs.length === 0 ? emptyState('No jobs yet','Add your first job') :
    `<table class="prospect-table"><thead><tr><th>Client</th><th>Service</th><th>Date</th><th>Amount</th><th>Status</th></tr></thead><tbody>`+
    jobs.slice(0,4).map(j=>`<tr><td><strong>${j.clients?.name||'Unknown'}</strong></td><td>${j.service||'—'}</td><td>${j.date?new Date(j.date).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'—'}</td><td><strong>$${(j.amount||0).toLocaleString()}</strong></td><td>${jobBadge(j.status)}</td></tr>`).join('')+
    `</tbody></table>`;

  const di = document.getElementById('dashboard-invoices');
  di.innerHTML = invoices.length === 0 ? emptyState('No invoices yet','Create your first invoice') :
    `<table class="prospect-table"><thead><tr><th>Client</th><th>Amount</th><th>Date</th><th>Status</th></tr></thead><tbody>`+
    invoices.slice(0,5).map(i=>`<tr><td><strong>${i.clients?.name||'Unknown'}</strong></td><td><strong>$${(i.amount||0).toLocaleString()}</strong></td><td>${i.issued_date?new Date(i.issued_date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'—'}</td><td>${invBadge(i.status)}</td></tr>`).join('')+
    `</tbody></table>`;
}

function renderClients() {
  const el = document.getElementById('clients-list');
  el.innerHTML = clients.length === 0 ? emptyState('No clients yet','Click "Add Client" to add your first client') :
    `<table class="prospect-table"><thead><tr><th>Client</th><th>Location</th><th>Surface</th><th>Courts</th><th>Total Billed</th><th>Status</th></tr></thead><tbody>`+
    clients.map(c=>`<tr>
      <td><div style="display:flex;align-items:center;gap:10px"><div class="client-avatar" style="width:32px;height:32px;font-size:12px">${c.name.substring(0,2).toUpperCase()}</div><strong>${c.name}</strong></div></td>
      <td>${c.location||'—'}</td><td>${surfaceTag(c.surface)}</td><td>${c.courts||1}</td>
      <td><strong>$${(c.total_billed||0).toLocaleString()}</strong></td>
      <td><span class="status-badge badge-active">Active</span></td></tr>`).join('')+
    `</tbody></table>`;
}

function renderJobs() {
  const el = document.getElementById('jobs-list');
  el.innerHTML = jobs.length === 0 ? emptyState('No jobs yet','Click "Add Job" to schedule your first job') :
    `<table class="prospect-table"><thead><tr><th>Client</th><th>Service</th><th>Date</th><th>Amount</th><th>Status</th></tr></thead><tbody>`+
    jobs.map(j=>`<tr><td><strong>${j.clients?.name||'Unknown'}</strong></td><td>${j.service||'—'}</td><td>${j.date?new Date(j.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'—'}</td><td><strong>$${(j.amount||0).toLocaleString()}</strong></td><td>${jobBadge(j.status)}</td></tr>`).join('')+
    `</tbody></table>`;
}

function renderInvoices() {
  const el = document.getElementById('invoices-list');
  el.innerHTML = invoices.length === 0 ? emptyState('No invoices yet','Click "New Invoice" to create your first invoice') :
    `<table class="prospect-table"><thead><tr><th>Client</th><th>Amount</th><th>Issued</th><th>Status</th></tr></thead><tbody>`+
    invoices.map(i=>`<tr><td><strong>${i.clients?.name||'Unknown'}</strong></td><td><strong>$${(i.amount||0).toLocaleString()}</strong></td><td>${i.issued_date?new Date(i.issued_date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'—'}</td><td>${invBadge(i.status)}</td></tr>`).join('')+
    `</tbody></table>`;
}

async function saveClient() {
  const name = document.getElementById('client-name').value.trim();
  if (!name) { showToast('Please enter a client name', false); return; }
  const { error } = await sb.from('clients').insert({
    name, location: document.getElementById('client-location').value.trim(),
    surface: document.getElementById('client-surface').value,
    courts: parseInt(document.getElementById('client-courts').value)||1,
    notes: document.getElementById('client-notes').value.trim()
  });
  if (error) { showToast('Error: '+error.message, false); return; }
  closeModal('client');
  ['client-name','client-location','client-courts','client-notes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('client-surface').value='';
  showToast('Client saved!', true);
  await loadClients(); renderDashboard();
}

async function saveJob() {
  const clientId = document.getElementById('job-client').value;
  const service = document.getElementById('job-service').value.trim();
  if (!clientId||!service) { showToast('Please fill in all fields', false); return; }
  const { error } = await sb.from('jobs').insert({
    client_id: clientId, service,
    date: document.getElementById('job-date').value,
    amount: parseFloat(document.getElementById('job-amount').value)||0,
    status: document.getElementById('job-status').value
  });
  if (error) { showToast('Error: '+error.message, false); return; }
  closeModal('job');
  showToast('Job saved!', true);
  await loadJobs(); renderDashboard();
}

async function saveInvoice() {
  const clientId = document.getElementById('invoice-client').value;
  const amount = parseFloat(document.getElementById('invoice-amount').value);
  if (!clientId||!amount) { showToast('Please fill in all fields', false); return; }
  const { error } = await sb.from('invoices').insert({
    client_id: clientId, amount,
    status: document.getElementById('invoice-status').value
  });
  if (error) { showToast('Error: '+error.message, false); return; }
  closeModal('invoice');
  showToast('Invoice created!', true);
  await loadInvoices(); renderDashboard();
}

function openModal(type) {
  if (type==='job'||type==='invoice') {
    const id = type==='job'?'job-client':'invoice-client';
    document.getElementById(id).innerHTML = '<option value="">Select client</option>'+
      clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  }
  document.getElementById('modal-'+type).classList.add('open');
}

function closeModal(type) { document.getElementById('modal-'+type).classList.remove('open'); }

document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if(e.target===o) o.classList.remove('open'); });
});

function showView(name, el) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  if(el) el.classList.add('active');
  document.getElementById('main-content').scrollTop=0;
}

function surfaceTag(s) {
  if(!s) return '<span class="surface-tag tag-default">—</span>';
  const m={'Har-Tru':'tag-hartru','Hard':'tag-hard','Red Clay':'tag-clay','Hard Court (Asphalt/Concrete)':'tag-hard'};
  return `<span class="surface-tag ${m[s]||'tag-default'}">${s}</span>`;
}
function jobBadge(s) { const m={scheduled:'inv-pending',completed:'inv-paid',cancelled:'inv-overdue'}; return `<span class="invoice-status ${m[s]||'inv-pending'}">${s||'scheduled'}</span>`; }
function invBadge(s) { const m={paid:'inv-paid',pending:'inv-pending',overdue:'inv-overdue'}; return `<span class="invoice-status ${m[s]||'inv-pending'}">${s||'pending'}</span>`; }
function emptyState(t,s) { return `<div class="empty-state"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><p><strong>${t}</strong><br>${s}</p></div>`; }
function showToast(msg, ok=true) { const t=document.getElementById('toast'); t.textContent=msg; t.className='toast show'+(ok?' success':''); setTimeout(()=>t.className='toast',3000); }
</script>
</body>
</html>
