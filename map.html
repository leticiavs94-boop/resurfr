<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resurfr ‚Äî Court Map</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800;900&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<style>
:root{--yellow:#C8E62B;--ydim:rgba(200,230,43,0.12);--green:#1E4D35;--off:#F4F6F1;--border:#E2E8DC;--charcoal:#181C17;--text:#1A1F18;--muted:#6B7A65;--lmuted:#9DAA96;}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;font-family:'DM Sans',sans-serif;background:var(--off);color:var(--text);overflow:hidden}
#loading-screen{position:fixed;inset:0;background:var(--charcoal);display:flex;align-items:center;justify-content:center;z-index:999;flex-direction:column;gap:16px}
#loading-screen .logo{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:900;color:white}
#loading-screen .spin{width:24px;height:24px;border:3px solid rgba(255,255,255,0.2);border-top-color:var(--yellow);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#app{display:none;flex-direction:column;height:100dvh;height:100vh}
.topbar{background:white;border-bottom:1px solid var(--border);padding:0 16px;height:54px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;z-index:200}
.topbar-left{display:flex;align-items:center;gap:10px}
.back-btn{display:flex;align-items:center;gap:5px;font-size:13px;font-weight:600;color:var(--muted);text-decoration:none}
.back-btn svg{width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.divider{width:1px;height:18px;background:var(--border)}
.page-title{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;color:var(--charcoal)}
.btn{padding:7px 14px;border-radius:7px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
.btn svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2.5;stroke-linecap:round}
.btn-yellow{background:var(--yellow);color:var(--charcoal)}
.btn-ghost{background:var(--off);color:var(--muted);border:1px solid var(--border)}
.btn-ghost.on{background:var(--ydim);border-color:rgba(200,230,43,0.4);color:var(--green)}
.stats-strip{display:flex;background:white;border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto}
.stats-strip::-webkit-scrollbar{display:none}
.sstat{padding:8px 14px;text-align:center;border-right:1px solid var(--border);flex-shrink:0;cursor:pointer}
.sstat:last-child{border-right:none}
.sval{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;color:var(--charcoal);line-height:1}
.slbl{font-size:9px;color:var(--lmuted);margin-top:1px;text-transform:uppercase;letter-spacing:.5px}
.filters{background:white;border-bottom:1px solid var(--border);padding:8px 14px;display:flex;gap:6px;overflow-x:auto;flex-shrink:0;-webkit-overflow-scrolling:touch}
.filters::-webkit-scrollbar{display:none}
.map-wrap{display:flex;overflow:hidden;position:relative;flex:1;min-height:0;height:100%}
#map{flex:1;z-index:1}

/* Side panel - desktop only */
.side{width:280px;background:white;border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;transition:transform .3s}
.side-head{padding:12px 14px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:space-between}
.side-title{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;color:var(--charcoal)}
.side-sub{font-size:11px;color:var(--lmuted);margin-top:1px}
.court-list{overflow-y:auto;flex:1;-webkit-overflow-scrolling:touch}
.ci{display:flex;align-items:flex-start;gap:9px;padding:11px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
.ci:last-child{border-bottom:none}
.ci:hover,.ci.sel{background:#F2FAF6}
.ci.sel{border-left:3px solid var(--green)}
.ci-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:3px}
.ci-name{font-size:13px;font-weight:600;color:var(--charcoal);line-height:1.3}
.ci-meta{font-size:11px;color:var(--lmuted);margin-top:2px}
.ci-tags{display:flex;gap:4px;margin-top:4px;flex-wrap:wrap}
.tag{padding:2px 6px;border-radius:4px;font-size:9px;font-weight:700;letter-spacing:.3px}
.th{background:#E8F5EE;color:#2A7A52}.thard{background:#FDF3E0;color:#B8842A}.tclay{background:#FDEEE8;color:#A84E2A}.tdef{background:var(--off);color:var(--muted)}.tclient{background:#E8F5EE;color:#2A7A52}.tprospect{background:#FFF8E6;color:#B88000}.tprivate{background:#F0EEFF;color:#5040A0}

/* Mobile list toggle button */
.list-toggle{display:none;position:absolute;bottom:20px;left:50%;transform:translateX(-50%);z-index:100;background:var(--charcoal);border:none;border-radius:30px;padding:14px 28px;font-size:15px;font-weight:700;color:white;box-shadow:0 4px 20px rgba(0,0,0,0.3);cursor:pointer;align-items:center;gap:8px;white-space:nowrap}
.list-toggle svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round}

/* Mobile bottom sheet */
.detail-sheet{position:fixed;bottom:-100%;left:0;right:0;background:white;border-radius:24px 24px 0 0;z-index:400;transition:bottom .3s cubic-bezier(.4,0,.2,1);max-height:75vh;overflow-y:auto;box-shadow:0 -8px 40px rgba(0,0,0,0.2)}
.detail-sheet.open{bottom:0}
.sheet-inner{padding:16px 20px 40px}
.sheet-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 14px}
.sheet-name{font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:800;color:var(--charcoal);margin-bottom:4px;padding-right:32px}
.sheet-loc{font-size:13px;color:var(--lmuted);margin-bottom:12px}
.sheet-tags{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px}
.sheet-tag{padding:4px 10px;border-radius:5px;font-size:11px;font-weight:700}
.sheet-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);font-size:13px}
.sheet-row:last-child{border-bottom:none}
.sheet-row-label{color:var(--lmuted)}.sheet-row-val{font-weight:600;color:var(--charcoal)}
.sheet-note{font-size:13px;color:var(--muted);margin-top:12px;line-height:1.6;background:var(--off);padding:12px;border-radius:8px}
.close-sheet{position:absolute;top:14px;right:18px;background:var(--off);border:none;width:28px;height:28px;border-radius:50%;font-size:16px;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center}
.followup-section{margin-top:16px;background:var(--off);border-radius:12px;padding:14px}
.followup-title{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;color:var(--charcoal);margin-bottom:10px}
.followup-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
.fl{display:block;font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--lmuted);margin-bottom:4px;text-transform:uppercase}
.fi{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:9px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--charcoal);outline:none;background:white;-webkit-appearance:none}
.fi:focus{border-color:var(--green)}
.followup-save{width:100%;padding:11px;border-radius:8px;background:var(--charcoal);color:white;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;border:none}
.followup-save:disabled{opacity:.55}

/* Mapbox popup - desktop */
.mapboxgl-popup-content{padding:0!important;border-radius:14px!important;overflow:hidden!important;box-shadow:0 8px 32px rgba(0,0,0,0.18)!important;border:1px solid var(--border)!important;min-width:240px}
.mapboxgl-popup-close-button{font-size:18px!important;color:var(--muted)!important;padding:8px 10px!important;line-height:1!important;z-index:10!important}
.mapboxgl-popup-tip{display:none!important}
.pu{padding:14px}
.pu-name{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:var(--charcoal);margin-bottom:3px;line-height:1.1;padding-right:20px}
.pu-loc{font-size:11px;color:var(--lmuted);margin-bottom:8px}
.pu-tags{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px}
.pu-tag{padding:3px 8px;border-radius:4px;font-size:10px;font-weight:700}
.pu-note{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.4;padding-top:6px;border-top:1px solid var(--border)}
.pu-foot{background:var(--off);padding:9px 14px;border-top:1px solid var(--border);font-size:11px;color:var(--muted);display:flex;justify-content:space-between}

/* Mobile list overlay */
.mobile-list-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:350}
.mobile-list-overlay.open{display:block}
.mobile-list{position:fixed;bottom:0;left:0;right:0;background:white;border-radius:24px 24px 0 0;z-index:360;max-height:70vh;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1)}
.mobile-list.open{transform:translateY(0)}
.mobile-list-head{padding:16px 20px 12px;border-bottom:1px solid var(--border);flex-shrink:0}
.mobile-list-title{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:800;color:var(--charcoal)}
.mobile-list-sub{font-size:12px;color:var(--lmuted);margin-top:2px}
.mobile-list-courts{overflow-y:auto;flex:1}

/* Sheet backdrop */
.sheet-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:390}
.sheet-backdrop.open{display:block}

.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--charcoal);color:white;padding:12px 24px;border-radius:10px;font-size:13px;font-weight:500;z-index:700;opacity:0;transition:all .3s;white-space:nowrap}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}.toast.ok{background:var(--green)}

/* Overlay modal */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:500;display:none;align-items:center;justify-content:center;padding:20px}
.overlay.open{display:flex}
.modal{background:white;border-radius:24px;padding:24px 20px 28px;width:100%;max-width:520px;max-height:88vh;overflow-y:auto;box-shadow:0 24px 60px rgba(0,0,0,0.3)}
.modal-title{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--charcoal);margin-bottom:4px}
.modal-sub{font-size:13px;color:var(--lmuted);margin-bottom:18px}
.fg{margin-bottom:12px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.modal-btns{display:flex;gap:10px;margin-top:20px}
.modal-btns button{flex:1;padding:14px;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;border:none}
.bcancel{background:var(--off);color:var(--muted);border:1px solid var(--border)}
.bsave{background:var(--charcoal);color:white}
.bsave:disabled{opacity:.55;cursor:not-allowed}

@media(max-width:768px){
  .side{display:none}
  .list-toggle{display:flex}
  .topbar{padding:0 12px}
}
</style>
</head>
<body>

<div id="loading-screen"><div class="logo">Resurfr</div><div class="spin"></div></div>

<div id="app">
  <div class="topbar">
    <div class="topbar-left">
      <a href="/dashboard.html" class="back-btn"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>Dashboard</a>
      <div class="divider"></div>
      <div class="page-title">Court Map</div>
    </div>
    <button class="btn btn-yellow" onclick="openModal()"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add Court</button>
  </div>

  <div class="stats-strip">
    <div class="sstat" onclick="setFilterById('all')"><div class="sval" id="st-total">0</div><div class="slbl">Total</div></div>
    <div class="sstat" onclick="setFilterById('client')"><div class="sval" id="st-clients" style="color:#1E4D35">0</div><div class="slbl">Clients</div></div>
    <div class="sstat" onclick="setFilterById('prospect')"><div class="sval" id="st-prospects" style="color:#B88000">0</div><div class="slbl">Prospects</div></div>
    <div class="sstat" onclick="setFilterById('private')"><div class="sval" id="st-private" style="color:#5040A0">0</div><div class="slbl">Private</div></div>
    <div class="sstat" onclick="setFilterById('followup')"><div class="sval" id="st-due" style="color:#A84E2A">0</div><div class="slbl">Due</div></div>
  </div>

  <div class="filters" id="filter-bar">
    <button class="btn btn-ghost on" id="f-all" onclick="setFilterById('all')">All</button>
    <button class="btn btn-ghost" id="f-client" onclick="setFilterById('client')">‚úì Clients</button>
    <button class="btn btn-ghost" id="f-prospect" onclick="setFilterById('prospect')">üéØ Prospects</button>
    <button class="btn btn-ghost" id="f-private" onclick="setFilterById('private')">üè† Private</button>
    <button class="btn btn-ghost" id="f-followup" onclick="setFilterById('followup')">üîî Due</button>
    <button class="btn btn-ghost" id="f-Har-Tru" onclick="setFilterById('Har-Tru')">Har-Tru</button>
    <button class="btn btn-ghost" id="f-Hard" onclick="setFilterById('Hard')">Hard</button>
    <button class="btn btn-ghost" id="f-Red Clay" onclick="setFilterById('Red Clay')">Clay</button>
  </div>

  <div class="map-wrap">
    <div id="map"></div>
    <!-- Mobile list toggle -->
    <button class="list-toggle" onclick="openMobileList()">
      <svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
      <span id="list-toggle-count">Courts</span>
    </button>
    <!-- Desktop side panel -->
    <div class="side">
      <div class="side-head">
        <div><div class="side-title">Fairfield County Courts</div><div class="side-sub" id="panel-count">Loading...</div></div>
      </div>
      <div class="court-list" id="court-list"></div>
    </div>
  </div>
</div>

<!-- Sheet backdrop -->
<div class="sheet-backdrop" id="sheet-backdrop" onclick="closeSheet()"></div>

<!-- Bottom detail sheet (mobile tap on dot) -->
<div class="detail-sheet" id="detail-sheet">
  <div class="sheet-inner">
    <button class="close-sheet" onclick="closeSheet()">√ó</button>
    <div class="sheet-handle"></div>
    <div class="sheet-name" id="ds-name"></div>
    <div class="sheet-loc" id="ds-loc"></div>
    <div class="sheet-tags" id="ds-tags"></div>
    <div id="ds-rows"></div>
    <div class="sheet-note" id="ds-note" style="display:none"></div>
    <div class="followup-section" id="ds-followup" style="display:none">
      <div class="followup-title">üîî Follow-up Reminder</div>
      <div class="followup-row">
        <div><label class="fl">Status</label>
          <select class="fi" id="fu-status">
            <option value="Not contacted">Not contacted</option>
            <option value="Reached out">Reached out</option>
            <option value="Meeting set">Meeting set</option>
            <option value="Quote sent">Quote sent</option>
            <option value="Closed">Closed ‚úì</option>
          </select>
        </div>
        <div><label class="fl">Follow-up Date</label>
          <input type="date" class="fi" id="fu-date">
        </div>
      </div>
      <button class="followup-save" id="fu-save-btn" onclick="saveFollowup()">Save Reminder</button>
    </div>
  </div>
</div>

<!-- Mobile court list overlay -->
<div class="mobile-list-overlay" id="mob-list-overlay" onclick="closeMobileList()"></div>
<div class="mobile-list" id="mob-list">
  <div class="mobile-list-head">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <div class="mobile-list-title">Courts</div>
        <div class="mobile-list-sub" id="mob-panel-count">Loading...</div>
      </div>
      <button onclick="closeMobileList()" style="background:var(--off);border:none;border-radius:50%;width:28px;height:28px;font-size:18px;color:var(--muted);cursor:pointer">√ó</button>
    </div>
  </div>
  <div class="mobile-list-courts" id="mob-court-list"></div>
</div>

<!-- Add Court Modal -->
<div class="overlay" id="modal-overlay">
  <div class="modal">
    <div class="modal-title">Add Court</div>
    <div class="modal-sub">Add a club, school, or private residence</div>
    <div class="fg"><label class="fl">Facility / Owner Name</label><input type="text" class="fi" id="cn" placeholder="Westport Tennis Club or John Smith" autocomplete="off"></div>
    <div class="fg"><label class="fl">Address ‚Äî auto-pinned on map</label><input type="text" class="fi" id="ca" placeholder="123 Main St, Westport, CT" autocomplete="off"></div>
    <div class="row2">
      <div class="fg"><label class="fl">Surface</label><select class="fi" id="cs"><option value="">Select</option><option value="Har-Tru">Har-Tru</option><option value="Hard">Hard Court</option><option value="Red Clay">Red Clay</option></select></div>
      <div class="fg"><label class="fl">Courts</label><input type="number" class="fi" id="cc" placeholder="2" min="1" autocomplete="off"></div>
    </div>
    <div class="fg"><label class="fl">Type</label>
      <select class="fi" id="ctype">
        <option value="prospect">üéØ Prospect</option>
        <option value="client">‚úì Client</option>
        <option value="private">üè† Private Residence</option>
      </select>
    </div>
    <div class="fg"><label class="fl">Last Service</label><input type="text" class="fi" id="cls" placeholder="e.g. Spring 2023, Never, Unknown" autocomplete="off"></div>
    <div class="fg"><label class="fl">Notes</label><input type="text" class="fi" id="cno" placeholder="Condition, contact name, priority..." autocomplete="off"></div>
    <div class="modal-btns"><button class="bcancel" onclick="closeModal()">Cancel</button><button class="bsave" id="save-btn" onclick="saveCourt()">Add to Map</button></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const{createClient}=supabase;
const sb=createClient('https://qyrgkspwxjmbjnkaixag.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5cmdrc3B3eGptYmpua2FpeGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NzQ0NTgsImV4cCI6MjA4NzU1MDQ1OH0.AHE_1iR8De17u-bVwsfzPc0nKK8MCDB5SEU5Ks531DA');
mapboxgl.accessToken='pk.eyJ1IjoibHZzMTIzIiwiYSI6ImNtbTFmbGVxbzA5MXgycHBuZzFzZm01ZDMifQ.32iLC3uNxgBQ9dZuN9D70A';

let courts=[],map,activeFilter='all',selectedId=null,popupRef=null,sheetCourtId=null;
const isMobile=()=>window.innerWidth<=768;
const today=new Date(new Date().toDateString());
const tomorrow=new Date(today.getTime()+86400000);
const nextWeek=new Date(today.getTime()+7*86400000);

const SEED=[
  {id:'s1',name:'Westport Tennis Club',location:'Westport, CT',surface:'Har-Tru',courts:6,status:'client',last_service:'Feb 2026',lat:41.1415,lng:-73.3579,notes:'Annual topdressing client. Contact: Tom Walsh.'},
  {id:'s2',name:'Greenwich Country Club',location:'Greenwich, CT',surface:'Hard',courts:8,status:'client',last_service:'Oct 2025',lat:41.0534,lng:-73.6282,notes:'Full resurfacing due 2030.'},
  {id:'s3',name:'Darien Lawn Club',location:'Darien, CT',surface:'Hard',courts:6,status:'client',last_service:'2023',lat:41.0731,lng:-73.4690,notes:'Crack fill and color coat done last season.'},
  {id:'s4',name:'New Canaan Country School',location:'New Canaan, CT',surface:'Red Clay',courts:3,status:'client',last_service:'Apr 2025',lat:41.1468,lng:-73.4940,notes:'Seasonal clay prep every spring.'},
  {id:'s5',name:'Wilton YMCA',location:'Wilton, CT',surface:'Har-Tru',courts:2,status:'client',last_service:'Apr 2025',lat:41.1954,lng:-73.4365,notes:'Annual maintenance contract.'},
  {id:'s6',name:'Stamford Athletic Club',location:'Stamford, CT',surface:'Hard',courts:4,status:'prospect',last_service:'2018',lat:41.0534,lng:-73.5387,notes:'Overdue ‚Äî last resurfaced 2018. High priority.'},
  {id:'s7',name:'Ridgefield Tennis Center',location:'Ridgefield, CT',surface:'Har-Tru',courts:5,status:'prospect',last_service:'Never',lat:41.2815,lng:-73.4982,notes:'Never professionally serviced.'},
  {id:'s8',name:'Fairfield Sportsplex',location:'Fairfield, CT',surface:'Hard',courts:4,status:'prospect',last_service:'2020',lat:41.1408,lng:-73.2637,notes:'Color coat fading, cracks forming.'},
  {id:'s9',name:'Trumbull Tennis Club',location:'Trumbull, CT',surface:'Red Clay',courts:3,status:'prospect',last_service:'Never',lat:41.2431,lng:-73.2009,notes:'New contact ‚Äî follow up in March.'},
  {id:'s10',name:'Westchester Country Club',location:'Rye, NY',surface:'Har-Tru',courts:10,status:'prospect',last_service:'2023',lat:40.9801,lng:-73.6854,notes:'Large account ‚Äî 10 Har-Tru courts.'},
  {id:'s11',name:'New Canaan Field Club',location:'New Canaan, CT',surface:'Har-Tru',courts:4,status:'prospect',last_service:'2022',lat:41.1534,lng:-73.4962,notes:'Har-Tru renewal due.'},
  {id:'s12',name:'Tokeneke Club',location:'Darien, CT',surface:'Hard',courts:6,status:'prospect',last_service:'2021',lat:41.0612,lng:-73.4825,notes:'Crack fill needed on 2 courts.'},
  {id:'s13',name:'Round Hill Club',location:'Greenwich, CT',surface:'Har-Tru',courts:8,status:'prospect',last_service:'2023',lat:41.0712,lng:-73.6634,notes:'Premium club ‚Äî big opportunity.'},
  {id:'s14',name:'Woodway Country Club',location:'Darien, CT',surface:'Hard',courts:5,status:'prospect',last_service:'2022',lat:41.0889,lng:-73.4521,notes:'Color coat fading.'},
  {id:'s15',name:'Wee Burn Country Club',location:'Darien, CT',surface:'Har-Tru',courts:6,status:'prospect',last_service:'2023',lat:41.0823,lng:-73.4612,notes:'Annual topdressing opportunity.'},
  {id:'s16',name:'Ox Ridge Hunt Club',location:'Darien, CT',surface:'Hard',courts:4,status:'prospect',last_service:'2019',lat:41.0756,lng:-73.4734,notes:'Overdue by several years.'},
  {id:'s17',name:'Country Club of Fairfield',location:'Fairfield, CT',surface:'Hard',courts:6,status:'prospect',last_service:'2021',lat:41.1356,lng:-73.2489,notes:'Full resurfacing candidate.'},
  {id:'s18',name:'Greens Farms Academy',location:'Westport, CT',surface:'Hard',courts:4,status:'prospect',last_service:'2022',lat:41.1123,lng:-73.3456,notes:'School ‚Äî contact athletics dept.'},
  {id:'s19',name:'Staples High School',location:'Westport, CT',surface:'Hard',courts:6,status:'prospect',last_service:'2020',lat:41.1289,lng:-73.3612,notes:'Town courts ‚Äî go through Parks & Rec.'},
  {id:'s20',name:'New Canaan High School',location:'New Canaan, CT',surface:'Hard',courts:4,status:'prospect',last_service:'2021',lat:41.1534,lng:-73.5012,notes:'School district courts.'},
  {id:'p1',name:'Private Estate ‚Äî Westport',location:'Westport, CT',surface:'Har-Tru',courts:1,status:'private',last_service:'2022',lat:41.1512,lng:-73.3712,notes:'1 Har-Tru court. Referred by Tom Walsh.'},
  {id:'p2',name:'Private Estate ‚Äî Greenwich',location:'Greenwich, CT',surface:'Hard',courts:2,status:'private',last_service:'2020',lat:41.0623,lng:-73.6123,notes:'2 hard courts. Resurfacing overdue.'},
  {id:'p3',name:'Private Residence ‚Äî Darien',location:'Darien, CT',surface:'Har-Tru',courts:1,status:'private',last_service:'Never',lat:41.0812,lng:-73.4723,notes:'New build ‚Äî never serviced.'},
  {id:'p4',name:'Private Estate ‚Äî New Canaan',location:'New Canaan, CT',surface:'Red Clay',courts:2,status:'private',last_service:'Apr 2024',lat:41.1623,lng:-73.5034,notes:'2 clay courts. Annual contract potential.'},
  {id:'p5',name:'Private Residence ‚Äî Wilton',location:'Wilton, CT',surface:'Hard',courts:1,status:'private',last_service:'2021',lat:41.1912,lng:-73.4423,notes:'1 asphalt court. Crack fill needed.'},
  {id:'p6',name:'Private Estate ‚Äî Greenwich',location:'Greenwich, CT',surface:'Har-Tru',courts:2,status:'private',last_service:'2023',lat:41.0734,lng:-73.6534,notes:'2 Har-Tru courts. Gated ‚Äî call ahead.'},
  {id:'p7',name:'Private Residence ‚Äî Westport',location:'Westport, CT',surface:'Hard',courts:1,status:'private',last_service:'2019',lat:41.1334,lng:-73.3534,notes:'Hard court not done since 2019.'},
  {id:'p8',name:'Private Estate ‚Äî Darien',location:'Darien, CT',surface:'Har-Tru',courts:1,status:'private',last_service:'Apr 2025',lat:41.0934,lng:-73.4834,notes:'Annual Har-Tru client. Very responsive.'},
  {id:'p9',name:'Private Residence ‚Äî Stamford',location:'Stamford, CT',surface:'Hard',courts:1,status:'private',last_service:'Never',lat:41.0634,lng:-73.5534,notes:'Never serviced. Referred by neighbor.'},
  {id:'p10',name:'Private Estate ‚Äî New Canaan',location:'New Canaan, CT',surface:'Har-Tru',courts:1,status:'private',last_service:'2022',lat:41.1434,lng:-73.4834,notes:'Owner very particular about quality.'},
];

async function boot(){
  // Start map init immediately (don't wait for auth)
  initMap();
  const{data:{session}}=await sb.auth.getSession();
  if(!session){window.location.href='/login.html';return;}
  const{data}=await sb.from('courts').select('*').order('created_at',{ascending:false});
  const db=(data||[]).map(c=>({...c,id:'db_'+c.id}));
  courts=[...SEED,...db];
  updateStats();renderMarkers();renderList();
  document.getElementById('loading-screen').style.display='none';
  document.getElementById('app').style.display='flex';
}
boot();

function initMap(){
  map=new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/light-v11',
    center:[-73.45,41.11], // Fairfield County center
    zoom:11,
    minZoom:9,
    maxZoom:18
  });
  map.addControl(new mapboxgl.NavigationControl(),'top-right');
  // Close sheet when tapping map background
  map.on('click',()=>{
    if(popupRef){popupRef.remove();popupRef=null;}
  });
  map.on('load',()=>{
    if(courts.length>0)renderMarkers();
  });
}

function renderMarkers(){
  document.querySelectorAll('.mbx-marker').forEach(el=>el.remove());
  getFiltered().forEach(court=>{
    if(!court.lat||!court.lng)return;
    const isClient=court.status==='client',isPrivate=court.status==='private';
    const isDue=isFollowupDue(court);
    const color=dotColor(court.surface,court.status);
    const border=isDue?'#A84E2A':isClient?'#1E4D35':isPrivate?'#5040A0':'#B88000';
    const size=isClient?16:isPrivate?13:11;
    const el=document.createElement('div');
    el.className='mbx-marker';
    el.style.cssText=`width:${size}px;height:${size}px;border-radius:50%;background:${color};border:2.5px solid ${border};box-shadow:0 2px 8px rgba(0,0,0,0.25);cursor:pointer;transition:transform .15s;position:relative`;
    if(isDue){
      const dot=document.createElement('div');
      dot.style.cssText='position:absolute;top:-3px;right:-3px;width:8px;height:8px;border-radius:50%;background:#A84E2A;border:1.5px solid white';
      el.appendChild(dot);
    }
    el.addEventListener('mouseenter',()=>el.style.transform='scale(1.5)');
    el.addEventListener('mouseleave',()=>el.style.transform='scale(1)');
    el.addEventListener('click',(e)=>{
      e.stopPropagation();
      selectCourt(court.id,false);
      if(isMobile()){
        showSheet(court);
      } else {
        if(popupRef)popupRef.remove();
        popupRef=new mapboxgl.Popup({offset:12,closeButton:true,maxWidth:'300px'})
          .setLngLat([court.lng,court.lat])
          .setHTML(buildPopup(court))
          .addTo(map);
      }
    });
    new mapboxgl.Marker({element:el,anchor:'center'}).setLngLat([court.lng,court.lat]).addTo(map);
  });
}

function buildPopup(c){
  const sc=surfTagStyle(c.surface),stc=statusTagStyle(c.status);
  return`<div class="pu">
    <div class="pu-name">${c.name}</div>
    <div class="pu-loc">${c.location||''}</div>
    <div class="pu-tags">
      <span class="pu-tag" style="${sc}">${c.surface||'Unknown'}</span>
      <span class="pu-tag" style="${stc}">${statusLabel(c.status)}</span>
    </div>
    <div style="font-size:11px;color:#9DAA96">Last service: <strong>${c.last_service||'Unknown'}</strong> ¬∑ ${c.courts||1} court${(c.courts||1)!==1?'s':''}</div>
    ${c.notes?`<div class="pu-note">${c.notes}</div>`:''}
  </div>
  <div class="pu-foot"><span>${statusLabel(c.status)}</span><span>${c.courts||1} court${(c.courts||1)!==1?'s':''}</span></div>`;
}

function showSheet(c){
  sheetCourtId=c.id;
  document.getElementById('ds-name').textContent=c.name;
  document.getElementById('ds-loc').textContent=c.location||'';
  document.getElementById('ds-tags').innerHTML=
    `<span class="sheet-tag" style="${surfTagStyle(c.surface)}">${c.surface||'‚Äî'}</span>
     <span class="sheet-tag" style="${statusTagStyle(c.status)}">${statusLabel(c.status)}</span>`;
  document.getElementById('ds-rows').innerHTML=[
    ['Courts',(c.courts||1)+' court'+((c.courts||1)!==1?'s':'')],
    ['Last Service',c.last_service||'Unknown'],
    ...(c.followup_status?[['Follow-up',c.followup_status]]:[]),
    ...(c.followup_date?[['Follow-up Date',formatDate(c.followup_date)]]:[]),
  ].map(([l,v])=>`<div class="sheet-row"><span class="sheet-row-label">${l}</span><span class="sheet-row-val">${v}</span></div>`).join('');
  const ne=document.getElementById('ds-note');
  if(c.notes){ne.textContent=c.notes;ne.style.display='block';}else ne.style.display='none';
  const fu=document.getElementById('ds-followup');
  if(c.status!=='client'){
    fu.style.display='block';
    document.getElementById('fu-status').value=c.followup_status||'Not contacted';
    document.getElementById('fu-date').value=c.followup_date||'';
  } else fu.style.display='none';
  document.getElementById('sheet-backdrop').classList.add('open');
  document.getElementById('detail-sheet').classList.add('open');
}

function closeSheet(){
  document.getElementById('detail-sheet').classList.remove('open');
  document.getElementById('sheet-backdrop').classList.remove('open');
  sheetCourtId=null;
}

function openMobileList(){
  renderMobileList();
  document.getElementById('mob-list-overlay').classList.add('open');
  document.getElementById('mob-list').classList.add('open');
}
function closeMobileList(){
  document.getElementById('mob-list-overlay').classList.remove('open');
  document.getElementById('mob-list').classList.remove('open');
}
function renderMobileList(){
  const f=getFiltered();
  document.getElementById('mob-panel-count').textContent=f.length+' court'+(f.length!==1?'s':'')+' shown';
  document.getElementById('mob-court-list').innerHTML=f.map(c=>`
    <div class="ci ${c.id===selectedId?'sel':''}" onclick="selectFromList('${c.id}')">
      <div class="ci-dot" style="background:${dotColor(c.surface,c.status)}"></div>
      <div style="flex:1;min-width:0">
        <div class="ci-name">${c.name}</div>
        <div class="ci-meta">${c.location||''} ¬∑ ${c.courts||1} court${(c.courts||1)!==1?'s':''}</div>
        <div class="ci-tags">${surfTag(c.surface)}<span class="tag ${c.status==='client'?'tclient':c.status==='private'?'tprivate':'tprospect'}">${statusLabel(c.status)}</span></div>
      </div>
    </div>`).join('');
}
function selectFromList(id){
  closeMobileList();
  const c=courts.find(x=>x.id===id);
  if(!c)return;
  selectCourt(id,true);
  setTimeout(()=>showSheet(c),400);
}

async function saveFollowup(){
  if(!sheetCourtId)return;
  const status=document.getElementById('fu-status').value;
  const date=document.getElementById('fu-date').value;
  const btn=document.getElementById('fu-save-btn');
  btn.disabled=true;btn.textContent='Saving...';
  if(sheetCourtId.startsWith('db_')){
    const realId=sheetCourtId.replace('db_','');
    const{error}=await sb.from('courts').update({followup_status:status,followup_date:date||null}).eq('id',realId);
    if(error){toast('Error: '+error.message,'err');btn.disabled=false;btn.textContent='Save Reminder';return;}
  }
  const idx=courts.findIndex(x=>x.id===sheetCourtId);
  if(idx>=0){courts[idx].followup_status=status;courts[idx].followup_date=date||null;}
  btn.disabled=false;btn.textContent='Save Reminder';
  toast('Follow-up saved! üîî','ok');
  renderMarkers();renderList();updateStats();
  closeSheet();
}

function renderList(){
  const f=getFiltered();
  const count=f.length+' court'+(f.length!==1?'s':'')+' shown';
  document.getElementById('panel-count').textContent=count;
  document.getElementById('list-toggle-count').textContent=f.length+' courts';
  document.getElementById('court-list').innerHTML=f.map(c=>`
    <div class="ci ${c.id===selectedId?'sel':''}" onclick="selectCourt('${c.id}',true)" id="ci-${c.id}">
      <div class="ci-dot" style="background:${dotColor(c.surface,c.status)}"></div>
      <div style="flex:1;min-width:0">
        <div class="ci-name">${c.name}</div>
        <div class="ci-meta">${c.location||''} ¬∑ ${c.courts||1} court${(c.courts||1)!==1?'s':''}</div>
        <div class="ci-tags">${surfTag(c.surface)}<span class="tag ${c.status==='client'?'tclient':c.status==='private'?'tprivate':'tprospect'}">${statusLabel(c.status)}</span></div>
      </div>
    </div>`).join('');
}

function selectCourt(id,flyTo=true){
  selectedId=id;
  const c=courts.find(x=>x.id===id);if(!c)return;
  if(flyTo&&c.lat&&c.lng)map.flyTo({center:[c.lng,c.lat],zoom:14,duration:600});
  document.querySelectorAll('.ci').forEach(el=>el.classList.remove('sel'));
  const item=document.getElementById('ci-'+id);
  if(item){item.classList.add('sel');item.scrollIntoView({behavior:'smooth',block:'nearest'});}
}

function getFiltered(){
  if(activeFilter==='all')return courts;
  if(activeFilter==='client')return courts.filter(c=>c.status==='client');
  if(activeFilter==='prospect')return courts.filter(c=>c.status==='prospect');
  if(activeFilter==='private')return courts.filter(c=>c.status==='private');
  if(activeFilter==='followup')return courts.filter(c=>isFollowupDue(c));
  return courts.filter(c=>c.surface===activeFilter);
}

function setFilterById(f){
  activeFilter=f;
  document.querySelectorAll('.filters .btn').forEach(b=>b.classList.remove('on'));
  const btn=document.getElementById('f-'+f);
  if(btn)btn.classList.add('on');
  renderMarkers();renderList();
}

function updateStats(){
  document.getElementById('st-total').textContent=courts.length;
  document.getElementById('st-clients').textContent=courts.filter(c=>c.status==='client').length;
  document.getElementById('st-prospects').textContent=courts.filter(c=>c.status==='prospect').length;
  document.getElementById('st-private').textContent=courts.filter(c=>c.status==='private').length;
  document.getElementById('st-due').textContent=courts.filter(c=>isFollowupDue(c)).length;
}

async function saveCourt(){
  const name=document.getElementById('cn').value.trim();
  const address=document.getElementById('ca').value.trim();
  if(!name){toast('Enter a name','err');return;}
  const btn=document.getElementById('save-btn');
  btn.disabled=true;btn.textContent='Locating...';
  let lat=41.11,lng=-73.45;
  if(address){try{const r=await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxgl.accessToken}&country=us&limit=1`);const g=await r.json();if(g.features&&g.features.length>0){lng=g.features[0].center[0];lat=g.features[0].center[1];}}catch(e){}}
  btn.textContent='Saving...';
  const{data,error}=await sb.from('courts').insert({name,location:address,surface:document.getElementById('cs').value,courts:parseInt(document.getElementById('cc').value)||1,status:document.getElementById('ctype').value,last_service:document.getElementById('cls').value,notes:document.getElementById('cno').value.trim(),lat,lng}).select().single();
  btn.disabled=false;btn.textContent='Add to Map';
  if(error){toast('Error: '+error.message,'err');return;}
  courts.push({...data,id:'db_'+data.id});
  updateStats();renderMarkers();renderList();closeModal();
  toast('Court added! üìç','ok');
  map.flyTo({center:[lng,lat],zoom:14,duration:800});
}

function openModal(){document.getElementById('modal-overlay').classList.add('open');}
function closeModal(){
  document.getElementById('modal-overlay').classList.remove('open');
  ['cn','ca','cc','cls','cno'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('cs').value='';
  document.getElementById('ctype').value='prospect';
}
document.getElementById('modal-overlay').addEventListener('click',e=>{if(e.target===document.getElementById('modal-overlay'))closeModal();});

function isFollowupDue(c){if(!c.followup_date)return false;return new Date(c.followup_date)<=nextWeek;}
function followupColor(c){if(!c.followup_date)return'var(--lmuted)';const d=new Date(c.followup_date);if(d<today)return'#A84E2A';if(d<=tomorrow)return'#B88000';return'#2A7A52';}
function formatDate(d){if(!d)return'';const dt=new Date(d+'T00:00:00');return dt.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
function dotColor(surface,status){
  if(status==='client'){if(surface==='Har-Tru')return'#4CAF80';if(surface==='Hard'||surface==='Hard Court')return'#D4A843';if(surface==='Red Clay')return'#C4633A';return'#4CAF80';}
  if(status==='private'){if(surface==='Har-Tru')return'#8B7DD8';if(surface==='Hard'||surface==='Hard Court')return'#A090CC';if(surface==='Red Clay')return'#CC88BB';return'#8B7DD8';}
  if(surface==='Har-Tru')return'#A8D5B5';if(surface==='Hard'||surface==='Hard Court')return'#E8CFA0';if(surface==='Red Clay')return'#E0A898';return'#C8D0C2';
}
function surfTagStyle(s){if(s==='Har-Tru')return'background:#E8F5EE;color:#2A7A52';if(s==='Hard'||s==='Hard Court')return'background:#FDF3E0;color:#B8842A';if(s==='Red Clay')return'background:#FDEEE8;color:#A84E2A';return'background:#F4F6F1;color:#6B7A65';}
function statusTagStyle(s){if(s==='client')return'background:#E8F5EE;color:#2A7A52';if(s==='private')return'background:#F0EEFF;color:#5040A0';return'background:#FFF8E6;color:#B88000';}
function statusLabel(s){if(s==='client')return'‚úì Client';if(s==='private')return'üè† Private';return'üéØ Prospect';}
function surfTag(s){const c=s==='Har-Tru'?'th':s==='Hard'||s==='Hard Court'?'thard':s==='Red Clay'?'tclay':'tdef';return`<span class="tag ${c}">${s||'‚Äî'}</span>`;}
function toast(msg,type='ok'){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show'+(type==='ok'?' ok':'');setTimeout(()=>t.className='toast',3000);}
</script>
</body>
</html>
